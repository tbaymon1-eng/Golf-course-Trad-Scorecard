<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Cypresswood Scorecard</title>

  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#7a4a0b">

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Scorecard">
  <link rel="apple-touch-icon" href="./assets/icon-192.png">

  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --paper:#e9e2d4; --ink:#111; --grid:#2b2b2b;
      --headerRow:#d8d1c3; --parRow:#a85a13; --parRowText:#fff;
      --hcpRow:#f2e6b9; --cellBg:#f8f4ea; --border:#7a4a0b; --card:#efe7d7;
    }
    *{ -webkit-tap-highlight-color: transparent; }
    body{ margin:0; background: var(--paper); color: var(--ink); font-family: Georgia, 'Times New Roman', serif; }
    .wrap{ max-width: 980px; margin: 0 auto; padding: 10px 10px 24px; }
    .card{ background: var(--card); border: 3px solid var(--border); border-radius: 12px; overflow: hidden; box-shadow: 0 8px 22px rgba(0,0,0,.18); }

    .header-img{
      width: 100%; height: auto !important; max-height: 210px; display: block;
      object-fit: contain !important; object-position: center !important; background: var(--card);
    }

    #joinScreen{ display:none; padding:12px 10px; background: var(--card); border-bottom:1px solid rgba(0,0,0,.08); }

    /* Sponsor strip (Scorecard) */
    #scoreSponsor{
      display:none;
      margin: 10px 10px 0;
      border:2px solid rgba(0,0,0,.14);
      border-radius:12px;
      background:rgba(255,255,255,.55);
      padding:10px 12px;
      cursor:pointer;
    }
    #scoreSponsor:active{ transform: translateY(1px); }
    #scoreSponsorTitle{ font-family:Cinzel,serif; font-weight:900; font-size:13px; opacity:.9; }
    #scoreSponsorRow{ display:flex; align-items:center; gap:10px; margin-top:8px; }
    #scoreSponsorLogo{
      width:44px; height:44px; border-radius:10px; object-fit:cover;
      border:2px solid rgba(0,0,0,.12); background:rgba(0,0,0,.06);
      display:none;
    }
    #scoreSponsorName{ font-weight:900; font-size:16px; }

    .coursebar{
      display:flex; align-items:center; justify-content: space-between; gap:10px;
      padding: 8px 10px; background: var(--card);
      border-top: 1px solid rgba(0,0,0,.08); border-bottom: 1px solid rgba(0,0,0,.08);
    }
    .course-title{ font-family:'Cinzel', serif; font-weight: 900; letter-spacing: .5px; font-size: 14px; line-height: 1.1; }
    .course-hint{ font-size: 12px; opacity:.8; }
    .course-select{
      border: 2px solid var(--border); background: #e7ddcb; border-radius: 10px;
      padding: 8px 10px; font-weight: 900; font-size: 14px;
    }

    .table-shell{ padding: 0px; background: var(--card); }
    .hint{ padding: 8px 12px 0; font-size: 13px; opacity:.85; }

    .scroll-x{
      overflow-x: auto; overflow-y: visible; -webkit-overflow-scrolling: touch;
      border: 2px solid var(--border); border-radius: 10px;
      background: rgba(255,255,255,.12);
      margin: 10px 10px 0;
      width: calc(100% - 20px);
      box-sizing: border-box;
    }

    table{ border-collapse: collapse; min-width: 1120px; width: 100%; }
    th, td{ border: 2px solid var(--grid); padding: 0; height: 34px; background: var(--cellBg); }

    .label, thead th{ font-family: 'Cinzel', serif; font-weight: 700; letter-spacing: 0.5px; }
    .label{
      width: 140px; font-weight: 900; padding: 0 10px; text-align: left;
      background: #e1d8c8; white-space: nowrap;
    }

    thead th{
      position: sticky; top: 0; z-index: 5;
      background: var(--headerRow); font-weight: 900;
      height: 42px; text-align:center;
    }

    .hole{ width: 44px; text-align:center; font-weight: 900; }
    .sum{ width: 60px; text-align:center; font-weight: 900; }

    .yard{
      text-align:center; font-family: Georgia, 'Times New Roman', serif;
      font-weight: 900; font-size: 16px;
    }

    .row-black td{ background:#0d2a55; color:#fff; }
    .row-blue  td{ background:#1f5ea8; color:#fff; }
    .row-white td{ background:#f7f7f7; color:#111; }
    .row-silver td{ background:#cfcfcf; color:#111; }
    .row-forest td{ background:#1f4f3a; color:#fff; }
    .row-copper td{ background:#a85a13; color:#fff; }

    .row-black .label{ background:#0b2246; color:#fff; }
    .row-blue  .label{ background:#174c89; color:#fff; }
    .row-white .label{ background:#f0f0f0; color:#111; }
    .row-silver .label{ background:#bdbdbd; color:#111; }
    .row-forest .label{ background:#163a2b; color:#fff; }
    .row-copper .label{ background:#8f4b10; color:#fff; }

    .row-par td{ background: var(--parRow); color: var(--parRowText); }
    .row-par .label{ background: #8f4b10; color:#fff; }

    .row-hcp td{ background: var(--hcpRow); color:#111; }
    .row-hcp .label{ background: #e9dcaa; }

    .score-input{
      width: 100%; height: 100%;
      border: 0; outline: none;
      background: transparent !important;
      text-align: center;
      font-weight: 950;
      font-size: 18px;
      color: #111;
      -webkit-appearance: none;
      appearance: none;
      font-family: Georgia, 'Times New Roman', serif;
    }
    .player-name{
      width: 100%; height: 100%;
      border: 0; outline: none;
      background: transparent !important;
      font-weight: 950;
      padding: 0 10px;
      font-size: 16px;
      font-family: Georgia, 'Times New Roman', serif;
      -webkit-appearance: none;
      appearance: none;
    }
    .score-input:focus, .player-name:focus{
      outline: none !important; box-shadow: none !important; background: transparent !important;
    }

    .total{
      text-align:center;
      font-weight: 1000;
      font-size: 18px;
      background:#f1eadb;
      font-family: Georgia, 'Times New Roman', serif;
    }

    .actions{
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      padding: 12px 10px 14px;
      background: var(--card);
    }

    button{
      border: 2px solid var(--border);
      background: #e7ddcb;
      border-radius: 10px;
      padding: 12px 10px;
      font-weight: 900;
      font-size: 16px;
      cursor:pointer;
    }
    button:active{ transform: translateY(1px); }

    .book-btn{
      display:flex; align-items:center; justify-content:center;
      border: 2px solid var(--border);
      background: #2f6b2f; color:#fff;
      border-radius: 10px;
      padding: 12px 10px;
      font-weight: 900;
      font-size: 16px;
      text-decoration:none;
      text-align:center;
    }
    .book-btn:active{ transform: translateY(1px); }

    .danger{
      background:#b6422d; color:#fff; border-color:#7a2b20;
      grid-column: 1 / -1;
    }
    .mini{ font-size: 14px; padding: 10px 10px; opacity: .95; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card" id="card">
      <img id="courseHeader" class="header-img" src="./assets/cypresswood_header.png" alt="Scorecard Header" />

      <div id="joinScreen">
        <div style="font-family:Cinzel,serif; font-weight:900; font-size:16px;">Join Tournament</div>
        <div id="joinMeta" style="margin-top:6px; font-size:13px; opacity:.85;"></div>

        <div style="display:grid; gap:10px; margin-top:12px;">
          <label style="font-weight:900; font-size:13px;">
            Your Name
            <input id="joinName" autocomplete="name"
              style="width:100%; padding:12px 10px; border:2px solid #7a4a0b; border-radius:10px; background:#fff;" />
          </label>

          <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <label style="font-weight:900; font-size:13px;">
              Group (optional)
              <input id="joinGroup"
                style="width:100%; padding:12px 10px; border:2px solid #7a4a0b; border-radius:10px; background:#fff;" />
            </label>

            <label style="font-weight:900; font-size:13px;">
              Start Hole (optional)
              <input id="joinStartHole" placeholder="1"
                style="width:100%; padding:12px 10px; border:2px solid #7a4a0b; border-radius:10px; background:#fff;" />
            </label>
          </div>
<label style="
  font-size:13px;
  display:flex;
  gap:8px;
  align-items:flex-start;
  margin-top:6px;
">
  <input type="checkbox" id="agreeTerms" />
  <span>
    I agree to the
    <a href="./terms.html" target="_blank">Terms of Service</a>
    and
    <a href="./privacy.html" target="_blank">Privacy Policy</a>
  </span>
</label>
          <button id="joinBtn" style="border:2px solid #7a4a0b; background:#2f6b2f; color:#fff; border-radius:10px; padding:12px 10px; font-weight:900; font-size:16px;">
            Join & Start Scoring
          </button>

          <button id="joinCancel" style="border:2px solid #7a4a0b; background:#e7ddcb; border-radius:10px; padding:12px 10px; font-weight:900; font-size:16px;">
            Exit Tournament
          </button>
        </div>
      </div>

      <!-- Sponsor strip shows for tournament if sponsor exists -->
      <div id="scoreSponsor" role="button" aria-label="Tournament Sponsor">
        <div id="scoreSponsorTitle">Tournament Sponsor</div>
        <div id="scoreSponsorRow">
          <img id="scoreSponsorLogo" alt="Sponsor Logo" />
          <div id="scoreSponsorName"></div>
        </div>
      </div>

      <div class="coursebar" id="courseSwipeZone">
        <div>
          <div class="course-title" id="courseTitle">Tradition Course</div>
          <div class="course-hint" id="courseHint">Swipe left/right here to switch courses</div>
        </div>

        <select class="course-select" id="courseSelect" aria-label="Select course">
          <option value="tradition">Tradition</option>
          <option value="cypress">Cypress</option>
        </select>
      </div>

      <div class="table-shell">
        <div class="hint" id="hintLine">Swipe left/right inside the table to scroll. Tap a box to type. Out/In/Tot auto-calc.</div>

        <div class="scroll-x">
          <table id="scoreTable">
            <thead><tr id="hdrRow"></tr></thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>

      <div class="actions">
        <button id="saveImg">Save as Image</button>

        <a
          id="bookBtn"
          href="https://foresightcypress.cps.golf/onlineresweb/search-teetime?TeeOffTimeMin=0&TeeOffTimeMax=23.999722222222225"
          target="_blank"
          class="book-btn"
        >
          Book Your Next Tee Time Here!
        </a>

        <button id="share">Share</button>
        <button class="danger" id="clear">Clear Card</button>
        <button class="mini" id="refreshApp">Refresh App (update)</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore,
      doc,
      setDoc,
      getDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBX2ycbIGEyQh-XgeOXtuhkyBT2XZvsHls",
      authDomain: "cypresswood-tournaments.firebaseapp.com",
      projectId: "cypresswood-tournaments",
      storageBucket: "cypresswood-tournaments.firebasestorage.app",
      messagingSenderId: "162441374966",
      appId: "1:162441374966:web:157285a2d5c39db1e810d7",
      measurementId: "G-HL6Y9CLV8K"
    };

    let db = null;
    let authReady = false;

    try{
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      await signInAnonymously(auth);
      db = getFirestore(app);
      authReady = true;
      console.log("Firebase ready âœ…");
    }catch(e){
      console.error("Firebase init/auth failed âŒ", e);
      alert("Firebase init/auth failed: " + (e?.message || e));
    }

    // ===== Courses =====
    const COURSE_TRADITION = {
      id: "tradition",
      title: "Tradition Course",
      headerImg: "./assets/cypresswood_header.png",
      teeRows: [
        { css:"row-black", label:"Black Tees",
          front:[465,384,203,448,606,376,528,196,453], out:3657,
          back:[405,256,545,464,185,394,472,318,546], inn:3563, tot:7220
        },
        { css:"row-blue", label:"Blue Tees",
          front:[373,356,195,422,565,343,508,169,409], out:3340,
          back:[370,211,518,423,169,357,439,291,520], inn:3298, tot:6638
        },
        { css:"row-white", label:"White Tees",
          front:[348,328,169,398,547,311,482,169,394], out:3146,
          back:[348,187,468,395,151,328,378,265,496], inn:3016, tot:6162
        },
        { css:"row-silver", label:"Silver Tees",
          front:[348,328,129,528,461,277,482,107,305], out:2765,
          back:[315,153,413,348,151,328,318,215,435], inn:2676, tot:5441
        }
      ],
      parFront:[4,4,3,4,5,4,5,3,4],
      parBack:[4,3,5,4,3,4,4,4,5],
      hcpFront:[7,17,11,1,3,13,9,15,5],
      hcpBack:[14,8,10,6,18,12,2,16,4],
      bottomRow:{
        css:"row-copper",
        label:"Copper Tees",
        front:[296,287,117,242,411,277,388,107,284], out:2409,
        back:[315,131,400,318,75,245,291,215,386], inn:2376, tot:4785
      }
    };

    const COURSE_CYPRESS = {
      id: "cypress",
      title: "Cypress Course",
      headerImg: "./assets/cypress_header.png",
      teeRows: [
        { css:"row-blue", label:"Blue",
          front:[514,396,387,482,486,182,417,189,417], out:3472,
          back:[416,409,388,349,149,566,351,465,441], inn:3134, tot:6006
        },
        { css:"row-forest", label:"Forest",
          front:[485,335,396,376,151,361,186,727,552], out:3053,
          back:[381,368,354,330,177,549,473,873,-1], inn:3713, tot:6168
        }
      ],
      parFront:[5,4,4,4,3,4,3,5,4],
      parBack:[4,4,4,4,3,5,3,5,4],
      hcpFront:[3,13,11,7,15,9,17,1,5],
      hcpBack:[6,10,12,14,18,2,16,4,8],
      extraRow:{
        css:"row-silver",
        label:"Silver",
        front:[456,305,305,357,119,557,137,493,321], out:2861,
        back:[277,315,519,320,117,515,127,461,342], inn:2793, tot:5694
      },
      bottomRow:{
        css:"row-copper",
        label:"Copper",
        front:[401,668,287,260,779,105,289,105,445], out:3638,
        back:[277,315,249,92,445,293,575,854,232], inn:2856, tot:4744
      }
    };

    const COURSES = { tradition: COURSE_TRADITION, cypress: COURSE_CYPRESS };

    // ===== Config =====
    const holesFront = [1,2,3,4,5,6,7,8,9];
    const holesBack  = [10,11,12,13,14,15,16,17,18];

    // ðŸ”¥ dynamic player rows
    let playersCount = 6;

    // ===== DOM =====
    const tbody = document.getElementById("tbody");
    const hdrRow = document.getElementById("hdrRow");
    const courseSelect = document.getElementById("courseSelect");
    const courseTitle = document.getElementById("courseTitle");
    const swipeZone = document.getElementById("courseSwipeZone");
    const courseHeaderImg = document.getElementById("courseHeader");
    const hintLine = document.getElementById("hintLine");

    const joinScreen = document.getElementById("joinScreen");
    const joinMeta = document.getElementById("joinMeta");
    const joinBtn = document.getElementById("joinBtn");
    const joinCancel = document.getElementById("joinCancel");
    const joinName = document.getElementById("joinName");
    const joinGroup = document.getElementById("joinGroup");
    const joinStartHole = document.getElementById("joinStartHole");
    const refreshBtn = document.getElementById("refreshApp");

    // sponsor UI
    const scoreSponsor = document.getElementById("scoreSponsor");
    const scoreSponsorLogo = document.getElementById("scoreSponsorLogo");
    const scoreSponsorName = document.getElementById("scoreSponsorName");

    // ===== State =====
    let currentCourseId = "tradition";
    let tournamentId = null;
    let isTournamentMode = false;
    let tournamentFormat = "stroke";

    // Sponsor state
    let sponsorUrl = "";

    function sum(arr){ return arr.reduce((a,b)=>a+(Number(b)||0),0); }

    function yardCell(v){
      if (v === -1) return `<td class="yard"></td>`;
      return `<td class="yard">${v ?? ""}</td>`;
    }

    function setCourseHeader(courseKey){
      const course = COURSES[courseKey];
      if(!courseHeaderImg || !course) return;
      courseHeaderImg.src = course.headerImg;
      courseHeaderImg.alt = courseKey === "cypress" ? "Cypress Header" : "Tradition Header";
    }

    function normalizeUrl(u){
      const s = (u || "").trim();
      if(!s) return "";
      if(/^https?:\/\//i.test(s)) return s;
      return "https://" + s; // âœ… auto-fix missing scheme
    }

    function applySponsorUI(name, logo, url){
      const n = (name || "").trim();
      const l = (logo || "").trim();
      sponsorUrl = normalizeUrl(url);

      if(!n && !l){
        scoreSponsor.style.display = "none";
        return;
      }

      scoreSponsor.style.display = "block";
      scoreSponsorName.textContent = n || "Tournament Sponsor";

      if(l){
        scoreSponsorLogo.src = l;
        scoreSponsorLogo.style.display = "block";
      }else{
        scoreSponsorLogo.style.display = "none";
      }

      scoreSponsor.style.cursor = sponsorUrl ? "pointer" : "default";
      scoreSponsor.onclick = () => {
        if(sponsorUrl) window.open(sponsorUrl, "_blank");
      };
    }

    function storageKeyFor(courseId){
      const tPart = (isTournamentMode && tournamentId) ? `_t_${tournamentId}` : "";
      const fPart = tournamentFormat ? `_f_${tournamentFormat}` : "";
      return `scorecard_state_${courseId}${tPart}${fPart}_v4`;
    }

    function makeDeviceId(){
      const existing = localStorage.getItem("t_device_id");
      if (existing) return existing;

      let id = "";
      try{ id = (crypto && crypto.randomUUID) ? crypto.randomUUID() : ""; }catch(e){}
      if(!id) id = "dev_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
      localStorage.setItem("t_device_id", id);
      return id;
    }

    function formatToPlayersCount(fmt){
      // âœ… you can adjust later, but this fixes scramble immediately:
      if(fmt === "scramble") return 1;
      if(fmt === "bestball") return 2;
      return 6; // stroke/skins default
    }

    function playerRowLabel(i){
      if(tournamentFormat === "scramble") return "Team Score";
      if(tournamentFormat === "bestball") return `Player ${i+1}`;
      return `Player ${i+1}`;
    }

    function buildHeader(){
      hdrRow.innerHTML = `
        <th class="label">Hole</th>
        ${holesFront.map(h=>`<th class="hole">${h}</th>`).join("")}
        <th class="sum">Out</th>
        <th class="sum">I<br>N<br>I<br>T</th>
        ${holesBack.map(h=>`<th class="hole">${h}</th>`).join("")}
        <th class="sum">In</th>
        <th class="sum">Tot</th>
        <th class="sum">Hcp</th>
        <th class="sum">Net</th>
      `;
    }

    function buildYardageRow(row){
      const tr = document.createElement("tr");
      tr.className = row.css;
      tr.innerHTML = `
        <td class="label">${row.label}</td>
        ${row.front.map(n=>yardCell(n)).join("")}
        ${yardCell(row.out)}
        ${yardCell("")}
        ${row.back.map(n=>yardCell(n)).join("")}
        ${yardCell(row.inn)}
        ${yardCell(row.tot)}
        ${yardCell("")}
        ${yardCell("")}
      `;
      return tr;
    }

    function buildParRow(course){
      const out = sum(course.parFront), inn = sum(course.parBack), tot = out + inn;
      const tr = document.createElement("tr");
      tr.className = "row-par";
      tr.innerHTML = `
        <td class="label">Par:</td>
        ${course.parFront.map(n=>yardCell(n)).join("")}
        ${yardCell(out)}
        ${yardCell("")}
        ${course.parBack.map(n=>yardCell(n)).join("")}
        ${yardCell(inn)}
        ${yardCell(tot)}
        ${yardCell("")}
        ${yardCell("")}
      `;
      return tr;
    }

    function buildHcpRow(course){
      const tr = document.createElement("tr");
      tr.className = "row-hcp";
      tr.innerHTML = `
        <td class="label">Handicap</td>
        ${course.hcpFront.map(n=>yardCell(n)).join("")}
        ${yardCell("")}
        ${yardCell("")}
        ${course.hcpBack.map(n=>yardCell(n)).join("")}
        ${yardCell("")}
        ${yardCell("")}
        ${yardCell("")}
        ${yardCell("")}
      `;
      return tr;
    }

    function cellInput(playerIdx, holeNum){
      const id = `p${playerIdx}_h${holeNum}`;
      return `
        <td>
          <input id="${id}" class="score-input" inputmode="text" maxlength="3" autocomplete="off" />
        </td>
      `;
    }

    function buildPlayerRow(i){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="label"><input class="player-name" placeholder="${playerRowLabel(i)}" /></td>
        ${holesFront.map(h=>cellInput(i,h)).join("")}
        <td class="total" data-out="${i}">0</td>
        <td></td>
        ${holesBack.map(h=>cellInput(i,h)).join("")}
        <td class="total" data-in="${i}">0</td>
        <td class="total" data-tot="${i}">0</td>
        <td></td>
        <td></td>
      `;
      return tr;
    }

    function recalcPlayer(i){
      let out=0, inn=0;
      for (const h of holesFront){
        const v = document.getElementById(`p${i}_h${h}`)?.value || "";
        out += parseInt(v, 10) || 0;
      }
      for (const h of holesBack){
        const v = document.getElementById(`p${i}_h${h}`)?.value || "";
        inn += parseInt(v, 10) || 0;
      }
      const tot = out + inn;

      const outEl = document.querySelector(`[data-out="${i}"]`);
      const inEl  = document.querySelector(`[data-in="${i}"]`);
      const totEl = document.querySelector(`[data-tot="${i}"]`);
      if(outEl) outEl.textContent = out;
      if(inEl) inEl.textContent = inn;
      if(totEl) totEl.textContent = tot;
    }

    function saveState(){
      const key = storageKeyFor(currentCourseId);
      const state = {
        names: Array.from(document.querySelectorAll(".player-name")).map(i => i.value || ""),
        scores: Array.from({length: playersCount}, (_,p) =>
          Array.from({length: 18}, (_,h) => {
            const el = document.getElementById(`p${p}_h${h+1}`);
            return el ? (el.value || "") : "";
          })
        )
      };
      localStorage.setItem(key, JSON.stringify(state));
      if (isTournamentMode) scheduleTournamentPush();
    }

    function loadState(){
      const key = storageKeyFor(currentCourseId);
      const raw = localStorage.getItem(key);
      if(!raw) return;

      try{
        const state = JSON.parse(raw);

        const nameInputs = document.querySelectorAll(".player-name");
        (state.names || []).forEach((v, idx) => { if(nameInputs[idx]) nameInputs[idx].value = v; });

        (state.scores || []).forEach((row, p) => {
          (row || []).forEach((v, hIdx) => {
            const el = document.getElementById(`p${p}_h${hIdx+1}`);
            if(el) el.value = v || "";
          });
        });

        for(let i=0;i<playersCount;i++) recalcPlayer(i);
      }catch(e){}
    }

    function clearState(){
      localStorage.removeItem(storageKeyFor(currentCourseId));
    }

    function wireInputs(){
      for (let i=0;i<playersCount;i++){
        for (let h=1;h<=18;h++){
          const el = document.getElementById(`p${i}_h${h}`);
          if(!el) continue;
          el.addEventListener("input", () => {
            el.value = (el.value || "").slice(0,3);
            recalcPlayer(i);
            saveState();
          });
        }
        recalcPlayer(i);
      }
      document.querySelectorAll(".player-name").forEach(inp => inp.addEventListener("input", saveState));
    }

    function build(){
      const course = COURSES[currentCourseId];
      courseTitle.textContent = course.title;
      courseSelect.value = currentCourseId;
      setCourseHeader(currentCourseId);

      // tweak hint for scramble
      hintLine.textContent =
        tournamentFormat === "scramble"
          ? "Scramble: enter ONE team score row. Swipe to scroll. Tap a box to type. Out/In/Tot auto-calc."
          : "Swipe left/right inside the table to scroll. Tap a box to type. Out/In/Tot auto-calc.";

      tbody.innerHTML = "";
      buildHeader();

      course.teeRows.forEach(r => tbody.appendChild(buildYardageRow(r)));
      tbody.appendChild(buildParRow(course));
      tbody.appendChild(buildHcpRow(course));

      for (let i=0;i<playersCount;i++) tbody.appendChild(buildPlayerRow(i));

      if (course.extraRow) tbody.appendChild(buildYardageRow(course.extraRow));
      tbody.appendChild(buildYardageRow(course.bottomRow));

      wireInputs();
      loadState();
    }

    // switching course disabled once joined tournament
    function setCourse(courseId){
      if (!COURSES[courseId]) return;
      if (isTournamentMode && joinScreen.style.display === "none" && courseId !== currentCourseId) return;
      currentCourseId = courseId;
      build();
    }

    courseSelect.addEventListener("change", () => setCourse(courseSelect.value));

    // swipe left/right on coursebar
    let touchStartX = null;
    swipeZone.addEventListener("touchstart", (e) => { touchStartX = e.changedTouches[0].clientX; }, { passive:true });
    swipeZone.addEventListener("touchend", (e) => {
      if (touchStartX === null) return;
      const dx = e.changedTouches[0].clientX - touchStartX;
      touchStartX = null;
      if (Math.abs(dx) < 50) return;
      if (dx < 0) setCourse(currentCourseId === "tradition" ? "cypress" : "tradition");
      else        setCourse(currentCourseId === "cypress" ? "tradition" : "cypress");
    }, { passive:true });

    async function captureFullCardCanvas(){
      const card = document.getElementById("card");
      const scroll = document.querySelector(".scroll-x");
      const table = document.getElementById("scoreTable");

      const oldOverflowX = scroll.style.overflowX;
      const oldOverflowY = scroll.style.overflowY;
      const oldWidth = scroll.style.width;
      const oldCardWidth = card.style.width;

      scroll.style.overflowX = "visible";
      scroll.style.overflowY = "visible";
      scroll.style.width = table.scrollWidth + "px";
      card.style.width = (table.scrollWidth + 40) + "px";

      try{
        return await html2canvas(card, {
          scale: 2,
          backgroundColor: null,
          windowWidth: card.scrollWidth,
          windowHeight: card.scrollHeight
        });
      } finally {
        scroll.style.overflowX = oldOverflowX;
        scroll.style.overflowY = oldOverflowY;
        scroll.style.width = oldWidth;
        card.style.width = oldCardWidth;
      }
    }

    function wireButtons(){
      const saveBtn = document.getElementById("saveImg");
      const shareBtn = document.getElementById("share");
      const clearBtn = document.getElementById("clear");

      saveBtn.addEventListener("click", async () => {
        try{
          const canvas = await captureFullCardCanvas();
          canvas.toBlob(async (blob) => {
            const file = new File([blob], "scorecard.png", { type: "image/png" });

            if (navigator.canShare && navigator.canShare({ files:[file] })) {
              await navigator.share({ files:[file], title:"Scorecard" });
              return;
            }

            const dataUrl = canvas.toDataURL("image/png");
            const w = window.open();
            if (w) w.document.write(`<img src="${dataUrl}" style="width:100%;height:auto" />`);
            else alert("Pop-up blocked. Try Share instead.");
          }, "image/png");
        }catch(e){
          alert("Save failed. Try again.");
        }
      });

      shareBtn.addEventListener("click", async () => {
        try{
          const canvas = await captureFullCardCanvas();
          const blob = await new Promise(res => canvas.toBlob(res, "image/png"));
          const file = new File([blob], "scorecard.png", { type:"image/png" });

          if (navigator.canShare && navigator.canShare({ files:[file] })){
            await navigator.share({ files:[file], title:"Scorecard" });
          } else {
            alert("Sharing not supported here. Use Save as Image.");
          }
        }catch(e){
          alert("Share failed. Use Save as Image.");
        }
      });

      clearBtn.addEventListener("click", () => {
        if(!confirm("Clear all scores for this course?")) return;
        document.querySelectorAll(".score-input").forEach(i => i.value = "");
        document.querySelectorAll(".player-name").forEach(i => i.value = "");
        clearState();
        for (let i=0;i<playersCount;i++) recalcPlayer(i);
        if (isTournamentMode) scheduleTournamentPush();
      });
    }

    // ===== Tournament mode =====
    async function checkTournamentFromURL(){
      const params = new URLSearchParams(location.search);
      const tId = (params.get("t") || "").trim();
      if (!tId) return;

      tournamentId = tId;
      isTournamentMode = true;

      joinScreen.style.display = "block";
      joinMeta.textContent = `Tournament ID: ${tournamentId}`;

      // Pull tournament settings (format, courseDefault, sponsor)
      if(db){
        try{
          const snap = await getDoc(doc(db, "tournaments", tournamentId));
          if(snap.exists()){
            const t = snap.data() || {};
            tournamentFormat = (t.format || "stroke").toString().trim();
            playersCount = formatToPlayersCount(tournamentFormat);

            // lock default course to the tournament choice
            const courseDefault = (t.courseDefault || "tradition").toString().trim();
            currentCourseId = COURSES[courseDefault] ? courseDefault : "tradition";

            // sponsor
            applySponsorUI(t.sponsorName || "", t.sponsorLogo || "", t.sponsorUrl || "");

            // build with new settings
            build();
          }
        }catch(e){
          console.warn("Tournament settings load failed", e);
        }
      }
    }

    joinBtn.addEventListener("click", async () => {
      if (!tournamentId) return;
      joinScreen.style.display = "none";

      // Save with tournament key + push once
      saveState();
      scheduleTournamentPush();
    });

    joinCancel.addEventListener("click", () => {
      joinScreen.style.display = "none";
      isTournamentMode = false;
      tournamentId = null;
      tournamentFormat = "stroke";
      playersCount = 6;
      applySponsorUI("","","");
      build();
    });

    // âœ… Flat map (no nested arrays) + totals
    function readScoresFromDOM(){
      const names = Array.from(document.querySelectorAll(".player-name")).map(i => i.value || "");

      const scoresFlat = {};
      for(let p=0; p<playersCount; p++){
        for(let h=1; h<=18; h++){
          const el = document.getElementById(`p${p}_h${h}`);
          const key = `p${p}_h${h}`;
          scoresFlat[key] = el && typeof el.value !== "undefined" ? String(el.value || "") : "";
        }
      }

      const totals = Array.from({length: playersCount}, (_,i) => ({
        out: Number(document.querySelector(`[data-out="${i}"]`)?.textContent || 0) || 0,
        inn: Number(document.querySelector(`[data-in="${i}"]`)?.textContent || 0) || 0,
        tot: Number(document.querySelector(`[data-tot="${i}"]`)?.textContent || 0) || 0
      }));

      return { names, scoresFlat, totals };
    }

    let pushTimer = null;
    function scheduleTournamentPush(){
      if (!db || !tournamentId || !authReady) return;
      if (pushTimer) clearTimeout(pushTimer);
      pushTimer = setTimeout(pushTournamentNow, 250);
    }

    async function pushTournamentNow(){
      if (!db || !tournamentId) return;

      const deviceId = makeDeviceId();
      const payload = readScoresFromDOM();

      const playerName = (joinName.value || payload.names[0] || "Player").trim();
      const group = (joinGroup.value || "").trim();
      const startHole = (joinStartHole.value || "").trim();

      const subRef = doc(db, "tournaments", tournamentId, "submissions", deviceId);

      try{
        await setDoc(subRef, {
          deviceId,
          courseId: currentCourseId,
          format: tournamentFormat, // helpful for admin/leaderboard
          playerName,
          group,
          startHole,
          names: payload.names,
          scoresFlat: payload.scoresFlat,
          totals: payload.totals,
          updatedAt: serverTimestamp()
        }, { merge:true });
      }catch(e){
        console.error("WRITE FAILED âŒ", e);
        alert("Firestore write failed: " + (e?.message || e));
      }
    }

    async function hardRefreshApp(){
      try{
        if ('serviceWorker' in navigator){
          const regs = await navigator.serviceWorker.getRegistrations();
          await Promise.all(regs.map(r => r.unregister()));
        }
      }catch(e){}
      try{
        if (window.caches){
          const keys = await caches.keys();
          await Promise.all(keys.map(k => caches.delete(k)));
        }
      }catch(e){}
      location.reload();
    }

    refreshBtn.addEventListener("click", () => {
      if(!confirm("Refresh app and pull latest update?")) return;
      hardRefreshApp();
    });

    // Init
    wireButtons();
    build();                 // initial build
    await checkTournamentFromURL(); // if tournament, it will rebuild with format/course/sponsor
  </script>
<div style="
  text-align:center;
  font-size:12px;
  opacity:.75;
  padding:18px 10px 28px;
  font-family:Cinzel, serif;
">
  Â© 2026 Cypresswood Golf Scorecard Â·
  <a href="./privacy.html">Privacy</a> Â·
  <a href="./terms.html">Terms</a>
</div>
  <script src="./pwa.js"></script>
</body>
</html>
