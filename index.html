<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
  // ---------- DATA (EXACT TO YOUR CARD) ----------
  const holesFront = [1,2,3,4,5,6,7,8,9];
  const holesBack  = [10,11,12,13,14,15,16,17,18];

  const tees = {
    black:  { label:"Black Tees",  front:[465,334,384,403,405,376,528,156,453], out:3667, back:[405,256,256,345,441,185,394,475,135], inn:3536, tot:7203 },
    blue:   { label:"Blue Tees",   front:[465,356,393,402,665,376,598,430,409], out:3340, back:[377,223,330,417,165,378,478,139,130], inn:3280, tot:6620 },
    silver: { label:"Silver Tees", front:[448,398,169,393,408,648,495,169,490], out:3140, back:[370,377,449,395,455,685,378,490,196], inn:2863, tot:6003 },
    green:  { label:"Silver Tees", front:[348,398,464,499,325,311,489,107,303], out:2765, back:[348,181,348,311,129,349,315,425,185], inn:2766, tot:5531 },
    copper: { label:"Copper Tees", front:[296,289,177,242,411,277,383,107,286], out:2409, back:[315,181,400,318,175,245,291,215,386], inn:2376, tot:4785 }
  };

  // Par row (Out 36, In 36, Total 72) â€“ matches your scorecard totals
  const parFront = [4,4,3,4,4,5,4,5,3]; // = 36
  const parBack  = [4,4,3,5,4,4,3,5,4]; // = 36

  // Handicap row (exact from your card)
  const hcpFront = [7,17,11,3,1,13,9,15,5];
  const hcpBack  = [14,8,10,6,18,12,13,6,4];

  const players = 6;

  // ---------- HELPERS ----------
  const tbody = document.getElementById("tbody");

  function sum(arr){ return arr.reduce((a,b)=>a+(Number(b)||0),0); }

  function buildHeader(){
    const hdr = document.getElementById("hdrRow");
    hdr.innerHTML = `
      <th class="label">Hole</th>
      ${holesFront.map(h=>`<th class="hole">${h}</th>`).join("")}
      <th class="sum">Out</th>
      <th class="sum">I<br>N<br>I<br>T</th>
      ${holesBack.map(h=>`<th class="hole">${h}</th>`).join("")}
      <th class="sum">In</th>
      <th class="sum">Tot</th>
      <th class="sum">Hcp</th>
      <th class="sum">Net</th>
    `;
  }

  function yardCell(v){ return `<td class="yard">${v ?? ""}</td>`; }

  function buildYardageRow(key, cssClass){
    const t = tees[key];
    const tr = document.createElement("tr");
    tr.className = cssClass;

    tr.innerHTML = `
      <td class="label">${t.label}</td>
      ${t.front.map(n=>yardCell(n)).join("")}
      ${yardCell(t.out)}
      ${yardCell("")} 
      ${t.back.map(n=>yardCell(n)).join("")}
      ${yardCell(t.inn)}
      ${yardCell(t.tot)}
      ${yardCell("")}
      ${yardCell("")}
    `;
    return tr;
  }

  function buildBlankRow(){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="label"></td>
      ${"<td></td>".repeat(9)}
      <td></td>
      <td></td>
      ${"<td></td>".repeat(9)}
      <td></td>
      <td></td>
      <td></td>
      <td></td>
    `;
    return tr;
  }

  function buildParRow(){
    const out = sum(parFront), inn = sum(parBack), tot = out+inn;
    const tr = document.createElement("tr");
    tr.className = "row-par";
    tr.innerHTML = `
      <td class="label">Par:</td>
      ${parFront.map(n=>yardCell(n)).join("")}
      ${yardCell(out)}
      ${yardCell("")}
      ${parBack.map(n=>yardCell(n)).join("")}
      ${yardCell(inn)}
      ${yardCell(tot)}
      ${yardCell("")}
      ${yardCell("")}
    `;
    return tr;
  }

  function buildHcpRow(){
    const tr = document.createElement("tr");
    tr.className = "row-hcp";
    tr.innerHTML = `
      <td class="label">Handicap</td>
      ${hcpFront.map(n=>yardCell(n)).join("")}
      ${yardCell("")}
      ${yardCell("")}
      ${hcpBack.map(n=>yardCell(n)).join("")}
      ${yardCell("")}
      ${yardCell("")}
      ${yardCell("")}
      ${yardCell("")}
    `;
    return tr;
  }

  function cellInput(playerIdx, holeNum){
    const id = `p${playerIdx}_h${holeNum}`;
    return `
      <td>
        <input
          id="${id}"
          class="score-input"
          inputmode="numeric"
          pattern="[0-9]*"
          maxlength="2"
          autocomplete="off"
          aria-label="Player ${playerIdx+1} hole ${holeNum}"
        />
      </td>
    `;
  }

  function buildPlayerRow(i){
    const tr = document.createElement("tr");

    const cellsFront = holesFront.map(h => cellInput(i,h)).join("");
    const cellsBack  = holesBack.map(h => cellInput(i,h)).join("");

    tr.innerHTML = `
      <td class="label"><input class="player-name" placeholder="Player ${i+1}" /></td>
      ${cellsFront}
      <td class="total" data-out="${i}">0</td>
      <td></td>
      ${cellsBack}
      <td class="total" data-in="${i}">0</td>
      <td class="total" data-tot="${i}">0</td>
      <td></td>
      <td></td>
    `;
    return tr;
  }

  function recalcPlayer(i){
    let out=0, inn=0;
    for (const h of holesFront){
      out += Number(document.getElementById(`p${i}_h${h}`).value || 0);
    }
    for (const h of holesBack){
      inn += Number(document.getElementById(`p${i}_h${h}`).value || 0);
    }
    const tot = out + inn;

    document.querySelector(`[data-out="${i}"]`).textContent = out;
    document.querySelector(`[data-in="${i}"]`).textContent = inn;
    document.querySelector(`[data-tot="${i}"]`).textContent = tot;
  }

  function wireInputs(){
    for (let i=0;i<players;i++){
      for (let h=1;h<=18;h++){
        const el = document.getElementById(`p${i}_h${h}`);
        el.addEventListener("input", () => {
          el.value = (el.value || "").replace(/[^\d]/g,"").slice(0,2);
          recalcPlayer(i);
        });
      }
      recalcPlayer(i);
    }
  }

  function build(){
    buildHeader();

    // Tee yardage rows (top section)
    tbody.appendChild(buildYardageRow("black","row-black"));
    tbody.appendChild(buildYardageRow("blue","row-blue"));
    tbody.appendChild(buildYardageRow("silver","row-silver"));
    tbody.appendChild(buildYardageRow("green","row-green"));

    // Blank scoring area (big empty grid look)
    tbody.appendChild(buildBlankRow());

    // Par & Handicap
    tbody.appendChild(buildParRow());
    tbody.appendChild(buildHcpRow());

    // 6 players
    for (let i=0;i<players;i++){
      tbody.appendChild(buildPlayerRow(i));
    }

    // Copper yardage row (bottom)
    tbody.appendChild(buildYardageRow("copper","row-copper"));

    wireInputs();
  }

  build();

// ---------- SAVE / SHARE / CLEAR (SAFE) ----------
const saveBtn = document.getElementById("saveImg");
const shareBtn = document.getElementById("share");
const clearBtn = document.getElementById("clear");

if (saveBtn){
  saveBtn.addEventListener("click", async () => {
    const node = document.getElementById("card");
    const canvas = await html2canvas(node, { scale: 2, backgroundColor: null });
    const dataUrl = canvas.toDataURL("image/png");
    const w = window.open();
    w.document.write(`<img src="${dataUrl}" style="width:100%;height:auto" />`);
  });
}

if (shareBtn){
  shareBtn.addEventListener("click", async () => {
    try{
      const node = document.getElementById("card");
      const canvas = await html2canvas(node, { scale: 2, backgroundColor: null });
      const blob = await new Promise(res => canvas.toBlob(res, "image/png"));
      const file = new File([blob], "cypresswood-scorecard.png", { type:"image/png" });

      if (navigator.canShare && navigator.canShare({ files:[file] })){
        await navigator.share({ files:[file], title:"Scorecard" });
      } else {
        alert("Sharing not supported here. Use Save as Image then share from Photos.");
      }
    } catch(e){
      alert("Share failed. Use Save as Image.");
    }
  });
}

if (clearBtn){
  clearBtn.addEventListener("click", () => {
    if(!confirm("Clear all scores?")) return;
    document.querySelectorAll(".score-input").forEach(i => i.value="");
    for (let i=0;i<players;i++) recalcPlayer(i);
  });
}

