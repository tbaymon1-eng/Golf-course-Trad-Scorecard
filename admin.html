<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Tournament Admin</title>
  <meta name="theme-color" content="#7a4a0b">

  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700;900&display=swap" rel="stylesheet">

  <style>
    :root{ --paper:#e9e2d4; --ink:#111; --border:#7a4a0b; --card:#efe7d7; }
    *{ -webkit-tap-highlight-color: transparent; }
    body{ margin:0; background:var(--paper); color:var(--ink); font-family:Georgia,'Times New Roman',serif; }
    .wrap{ max-width:900px; margin:0 auto; padding:12px; }
    .card{ background:var(--card); border:3px solid var(--border); border-radius:12px; padding:12px; box-shadow:0 8px 22px rgba(0,0,0,.18); }
    h1{ margin:0 0 8px; font-family:Cinzel,serif; font-weight:900; font-size:20px; }
    .row{ display:grid; gap:10px; margin-top:10px; }
    label{ font-weight:900; font-size:13px; display:block; }
    input, select{
      width:100%; box-sizing:border-box;
      padding:12px 10px; border:2px solid var(--border);
      border-radius:10px; background:#fff; font-size:16px;
      outline:none;
    }
    button{
      border:2px solid var(--border); background:#e7ddcb;
      border-radius:10px; padding:12px 10px; font-weight:900; font-size:16px;
    }
    button:active{ transform: translateY(1px); }
    .primary{ background:#2f6b2f; color:#fff; }
    .danger{ background:#b6422d; color:#fff; border-color:#7a2b20; }
    .box{
      margin-top:12px; padding:10px; border:2px dashed rgba(0,0,0,.25); border-radius:10px;
      background:rgba(255,255,255,.35);
      word-break: break-word;
    }
    .small{ font-size:13px; opacity:.85; }
    .mono{ font-family: ui-monospace, monospace; }
    .qrRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 10px;
      align-items: start;
    }
    .qrBox{
      background: rgba(255,255,255,.55);
      border: 2px solid rgba(0,0,0,.15);
      border-radius: 10px;
      padding: 10px;
    }
    .qrTitle{ font-weight: 900; font-size: 13px; margin-bottom: 8px; }
    .qrWrap{ display:flex; justify-content:center; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1>Admin Tournament Setup</h1>
      <div class="small">Create a tournament, then share the Join link + Leaderboard.</div>

      <!-- NAME + COURSE -->
      <div class="row" style="grid-template-columns:1fr 1fr;">
        <label>
          Tournament Name
          <input id="tName" placeholder="Cypresswood Saturday Skins" />
        </label>

        <label>
          Default Course
          <select id="tCourse">
            <option value="tradition">Tradition</option>
            <option value="cypress">Cypress</option>
          </select>
        </label>
      </div>

      <!-- ✅ FORMAT + DATE -->
      <div class="row" style="grid-template-columns:1fr 1fr;">
        <label>
          Format of Play
          <select id="tFormat">
            <option value="stroke">Stroke Play</option>
            <option value="scramble">Scramble (Team Score)</option>
            <option value="bestball">Best Ball</option>
            <option value="skins">Skins</option>
          </select>
        </label>

        <label>
          Date (optional)
          <input id="tDate" placeholder="2026-03-01" />
        </label>
      </div>

      <!-- ORGANIZER -->
      <div class="row">
        <label>
          Organizer Name (optional)
          <input id="tOrg" placeholder="Tirrel" />
        </label>
      </div>

      <!-- ✅ SPONSOR -->
      <div class="row" style="grid-template-columns:1fr 1fr;">
        <label>
          Sponsor Name (optional)
          <input id="tSponsorName" placeholder="Title Sponsor" />
        </label>

        <label>
          Sponsor Logo URL (optional)
          <input id="tSponsorLogo" placeholder="https://..." />
        </label>
      </div>

      <!-- BUTTONS -->
      <div class="row" style="grid-template-columns:1fr 1fr;">
        <button class="primary" id="createBtn">Create Tournament</button>
        <button id="loadBtn">Load Existing (by ID)</button>
      </div>

      <!-- IDS -->
      <div class="row" style="grid-template-columns:1fr 1fr;">
        <label>
          Tournament ID
          <input id="tId" class="mono"/>
        </label>
        <label>
          Admin Token
          <input id="adminToken" class="mono"/>
        </label>
      </div>

      <!-- LINKS -->
      <div class="box">
        <div class="small"><b>Join Link</b></div>
        <div id="joinLink" class="mono small"></div>

        <div style="height:10px"></div>

        <div class="small"><b>Leaderboard Link</b></div>
        <div id="lbLink" class="mono small"></div>

        <div class="qrRow">
          <div class="qrBox">
            <div class="qrTitle">Join QR</div>
            <div id="joinQR" class="qrWrap"></div>
          </div>

          <div class="qrBox">
            <div class="qrTitle">Leaderboard QR</div>
            <div id="lbQR" class="qrWrap"></div>
          </div>
        </div>
      </div>

      <div class="row" style="grid-template-columns:1fr 1fr;">
        <button id="copyJoin">Copy Join Link</button>
        <button id="copyLb">Copy Leaderboard Link</button>
      </div>

      <div class="row">
        <button class="danger" id="closeBtn">Close Tournament</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore,
      doc,
      setDoc,
      getDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBX2ycbIGEyQh-XgeOXtuhkyBT2XZvsHls",
      authDomain: "cypresswood-tournaments.firebaseapp.com",
      projectId: "cypresswood-tournaments"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const $ = id => document.getElementById(id);

    function randId(len=10){
      const chars="abcdefghijklmnopqrstuvwxyz0123456789";
      let s="";
      for(let i=0;i<len;i++) s+=chars[Math.floor(Math.random()*chars.length)];
      return s;
    }

    function baseURL(){
      const url=new URL(location.href);
      url.hash="";
      url.search="";
      url.pathname=url.pathname.replace(/\/admin\.html$/,"/");
      return url.toString();
    }

    function renderQR(el,text){
      el.innerHTML="";
      if(!text) return;
      const holder=document.createElement("div");
      el.appendChild(holder);
      new QRCode(holder,{text,width:180,height:180});
    }

    function buildLinks(id,token){
      const base=baseURL();
      const join=`${base}index.html?t=${id}`;
      const lb=`${base}leaderboard.html?t=${id}&admin=${token}`;
      $("joinLink").textContent=join;
      $("lbLink").textContent=lb;
      renderQR($("joinQR"),join);
      renderQR($("lbQR"),lb);
    }

    async function createTournament(){
      const id=randId(10);
      const token=randId(18);

      const payload={
        name: $("tName").value.trim(),
        courseDefault: $("tCourse").value,
        format: $("tFormat").value,
        date: $("tDate").value.trim(),
        organizer: $("tOrg").value.trim(),
        sponsorName: $("tSponsorName").value.trim(),
        sponsorLogo: $("tSponsorLogo").value.trim(),
        status:"open",
        adminToken:token,
        createdAt:serverTimestamp(),
        updatedAt:serverTimestamp()
      };

      await setDoc(doc(db,"tournaments",id),payload);

      $("tId").value=id;
      $("adminToken").value=token;
      buildLinks(id,token);
      alert("Tournament created!");
    }

    async function loadTournament(){
      const id=$("tId").value.trim();
      if(!id) return alert("Paste a Tournament ID first.");

      const snap=await getDoc(doc(db,"tournaments",id));
      if(!snap.exists()) return alert("Not found.");

      const d=snap.data();

      $("tName").value=d.name||"";
      $("tCourse").value=d.courseDefault||"tradition";
      $("tFormat").value=d.format||"stroke";
      $("tDate").value=d.date||"";
      $("tOrg").value=d.organizer||"";
      $("tSponsorName").value=d.sponsorName||"";
      $("tSponsorLogo").value=d.sponsorLogo||"";
      $("adminToken").value=d.adminToken||"";

      buildLinks(id,d.adminToken||"");
    }

    async function closeTournament(){
      const id=$("tId").value.trim();
      await setDoc(doc(db,"tournaments",id),{status:"closed"},{merge:true});
      alert("Tournament CLOSED.");
    }

    $("createBtn").onclick=createTournament;
    $("loadBtn").onclick=loadTournament;
    $("closeBtn").onclick=closeTournament;
  </script>
</body>
</html>
