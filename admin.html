<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Tournament Admin</title>
  <meta name="theme-color" content="#7a4a0b">

  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --paper:#e9e2d4; --ink:#111; --border:#7a4a0b; --card:#efe7d7; --chip: rgba(255,255,255,.55);
      --shadow: 0 8px 22px rgba(0,0,0,.18);
      --green:#2f6b2f; --danger:#b6422d;
    }
    *{ -webkit-tap-highlight-color: transparent; }
    body{ margin:0; background:var(--paper); color:var(--ink); font-family:Georgia,'Times New Roman',serif; }
    .wrap{ max-width:980px; margin:0 auto; padding:12px; }
    .card{
      background:var(--card);
      border:3px solid var(--border);
      border-radius:12px;
      padding:12px;
      box-shadow: var(--shadow);
    }
    h1{ margin:0 0 8px; font-family:Cinzel,serif; font-weight:900; font-size:20px; }
    .small{ font-size:13px; opacity:.85; }
    .row{ display:grid; gap:10px; margin-top:10px; }
    label{ font-weight:900; font-size:13px; display:block; }
    input, select, textarea{
      width:100%; box-sizing:border-box;
      padding:12px 10px;
      border:2px solid var(--border);
      border-radius:10px;
      background:#fff;
      font-size:16px;
      outline:none;
    }
    textarea{ min-height: 84px; resize: vertical; }
    button{
      border:2px solid var(--border);
      background:#e7ddcb;
      border-radius:10px;
      padding:12px 10px;
      font-weight:900;
      font-size:16px;
      cursor:pointer;
    }
    button:active{ transform: translateY(1px); }
    .primary{ background:var(--green); color:#fff; }
    .danger{ background:var(--danger); color:#fff; border-color:#7a2b20; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    .box{
      margin-top:12px;
      padding:10px;
      border:2px dashed rgba(0,0,0,.25);
      border-radius:10px;
      background:rgba(255,255,255,.35);
      word-break: break-word;
    }

    .qrRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 10px;
      align-items: start;
    }
    .qrBox{
      background: rgba(255,255,255,.55);
      border: 2px solid rgba(0,0,0,.15);
      border-radius: 10px;
      padding: 10px;
    }
    .qrTitle{ font-weight: 900; font-size: 13px; margin-bottom: 8px; }
    .qrWrap{ display:flex; justify-content:center; }

    .chip{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:8px 10px;
      border-radius:999px;
      background: var(--chip);
      border:2px solid rgba(0,0,0,.12);
      font-weight:900;
      font-size:12px;
    }
    .legal{
      margin-top: 12px;
      padding-top: 10px;
      border-top: 1px solid rgba(0,0,0,.12);
      font-size: 12px;
      opacity: .9;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content: space-between;
    }
    .legal a{
      color:#3d2a09;
      font-weight: 900;
      text-decoration:none;
      border-bottom: 1px dashed rgba(61,42,9,.4);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1>Admin Tournament Setup</h1>
      <div class="small">Create a tournament, then share the Join link (QR) + Live Leaderboard link.</div>

      <!-- NAME + COURSE -->
      <div class="row" style="grid-template-columns:1fr 1fr;">
        <label>
          Tournament Name
          <input id="tName" placeholder="Cypresswood Saturday Skins" />
        </label>

        <label>
          Default Course
          <select id="tCourse">
            <option value="tradition">Tradition</option>
            <option value="cypress">Cypress</option>
          </select>
        </label>
      </div>

      <!-- FORMAT + DATE -->
      <div class="row" style="grid-template-columns:1fr 1fr;">
        <label>
          Format of Play
          <select id="tFormat">
            <option value="stroke">Stroke Play</option>
            <option value="scramble">Scramble (Team Score)</option>
            <option value="bestball">Best Ball</option>
            <option value="skins">Skins</option>
          </select>
        </label>

        <label>
          Date (optional)
          <input id="tDate" placeholder="2026-03-01" />
        </label>
      </div>

      <!-- ORGANIZER -->
      <div class="row">
        <label>
          Organizer Name (optional)
          <input id="tOrg" placeholder="Name" />
        </label>
      </div>

      <!-- SPONSOR -->
      <div class="row" style="grid-template-columns:1fr 1fr;">
        <label>
          Sponsor Name (optional)
          <input id="tSponsorName" placeholder="Title Sponsor" />
        </label>

        <label>
          Sponsor Logo URL (optional)
          <input id="tSponsorLogo" placeholder="https://..." />
        </label>
      </div>

      <div class="row">
        <label>
          Sponsor Website (optional)
          <input id="tSponsorUrl" placeholder="https://sponsor.com" />
        </label>
      </div>

      <!-- BUTTONS -->
      <div class="row" style="grid-template-columns:1fr 1fr;">
        <button class="primary" id="createBtn">Create Tournament</button>
        <button id="loadBtn">Load Existing (by ID)</button>
      </div>

      <!-- IDS -->
      <div class="row" style="grid-template-columns:1fr 1fr;">
        <label>
          Tournament ID
          <input id="tId" class="mono" placeholder="(auto or paste here)"/>
        </label>
        <label>
          Admin Token (auto)
          <input id="adminToken" class="mono" placeholder="(auto)"/>
        </label>
      </div>

      <div class="row">
        <div class="chip" id="statusChip">Status: —</div>
      </div>

      <!-- LINKS -->
      <div class="box">
        <div class="small"><b>Join Link (players scan this QR)</b></div>
        <div id="joinLink" class="mono small"></div>

        <div style="height:10px"></div>

        <div class="small"><b>Leaderboard Link (organizer view)</b></div>
        <div id="lbLink" class="mono small"></div>

        <div class="qrRow">
          <div class="qrBox">
            <div class="qrTitle">Join QR</div>
            <div id="joinQR" class="qrWrap"></div>
          </div>

          <div class="qrBox">
            <div class="qrTitle">Leaderboard QR</div>
            <div id="lbQR" class="qrWrap"></div>
          </div>
        </div>
      </div>

      <div class="row" style="grid-template-columns:1fr 1fr;">
        <button id="copyJoin">Copy Join Link</button>
        <button id="copyLb">Copy Leaderboard Link</button>
      </div>

      <div class="row" style="grid-template-columns:1fr 1fr;">
        <button id="saveBtn" class="primary">Save Updates</button>
        <button class="danger" id="closeBtn">Close Tournament</button>
      </div>

      <div class="legal">
        <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:center;">
          <a href="./privacy.html">Privacy</a>
          <a href="./terms.html">Terms</a>
        </div>
        <div>© <span id="yr"></span> Electronic Scorecard Solutions (DBA) • Elb Solutions LLC</div>
      </div>
    </div>
  </div>

  <!-- QR library MUST load before module -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore,
      doc,
      setDoc,
      getDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Same config you already use in index.html / leaderboard.html
    const firebaseConfig = {
      apiKey: "AIzaSyBX2ycbIGEyQh-XgeOXtuhkyBT2XZvsHls",
      authDomain: "cypresswood-tournaments.firebaseapp.com",
      projectId: "cypresswood-tournaments",
      storageBucket: "cypresswood-tournaments.firebasestorage.app",
      messagingSenderId: "162441374966",
      appId: "1:162441374966:web:157285a2d5c39db1e810d7",
      measurementId: "G-HL6Y9CLV8K"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const $ = (id) => document.getElementById(id);
    $("yr").textContent = String(new Date().getFullYear());

    const createBtn = $("createBtn");
    const loadBtn   = $("loadBtn");
    const saveBtn   = $("saveBtn");
    const closeBtn  = $("closeBtn");

    const statusChip = $("statusChip");

    const tName = $("tName");
    const tCourse = $("tCourse");
    const tFormat = $("tFormat");
    const tDate = $("tDate");
    const tOrg = $("tOrg");

    const tSponsorName = $("tSponsorName");
    const tSponsorLogo = $("tSponsorLogo");
    const tSponsorUrl  = $("tSponsorUrl");

    const tId = $("tId");
    const adminToken = $("adminToken");

    const joinLinkEl = $("joinLink");
    const lbLinkEl = $("lbLink");
    const joinQREl = $("joinQR");
    const lbQREl = $("lbQR");

    const copyJoin = $("copyJoin");
    const copyLb = $("copyLb");

    function randId(len=10){
      const chars = "abcdefghijklmnopqrstuvwxyz0123456789";
      let s = "";
      for(let i=0;i<len;i++) s += chars[Math.floor(Math.random()*chars.length)];
      return s;
    }

    function baseURL(){
      const url = new URL(location.href);
      url.hash = "";
      url.search = "";
      url.pathname = url.pathname.replace(/\/admin\.html$/,"/");
      return url.toString();
    }

    function renderQR(el, text){
      if (!el) return;
      el.innerHTML = "";
      if (!text) return;

      const holder = document.createElement("div");
      el.appendChild(holder);

      new QRCode(holder, {
        text,
        width: 180,
        height: 180,
        correctLevel: QRCode.CorrectLevel.M
      });
    }

    function buildLinks(id, token){
      const base = baseURL();

      const join = new URL(base + "index.html");
      join.searchParams.set("t", id);

      const lb = new URL(base + "leaderboard.html");
      lb.searchParams.set("t", id);
      if(token) lb.searchParams.set("admin", token);

      joinLinkEl.textContent = join.toString();
      lbLinkEl.textContent = lb.toString();

      renderQR(joinQREl, join.toString());
      renderQR(lbQREl, lb.toString());
    }

    function normalizeUrl(u){
      const s = (u || "").trim();
      if(!s) return "";
      if(/^https?:\/\//i.test(s)) return s;
      return "https://" + s;
    }

    function setStatusUI(status){
      const s = (status || "open").toString();
      statusChip.textContent = `Status: ${s.toUpperCase()}`;
      statusChip.style.opacity = "1";
    }

    async function createTournament(){
      const id = randId(10);
      const token = randId(18);

      const payload = {
        name: (tName.value || "Golf Tournament").trim(),
        courseDefault: tCourse.value,
        format: tFormat.value,
        date: (tDate.value || "").trim(),
        organizer: (tOrg.value || "Name").trim(),

        sponsorName: (tSponsorName.value || "").trim(),
        sponsorLogo: (tSponsorLogo.value || "").trim(),
        sponsorUrl: normalizeUrl(tSponsorUrl.value),

        status: "open",
        adminToken: token,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      };

      await setDoc(doc(db, "tournaments", id), payload, { merge:false });

      tId.value = id;
      adminToken.value = token;
      buildLinks(id, token);
      setStatusUI("open");
      alert("Tournament created!");
    }

    async function loadTournament(){
      const id = (tId.value || "").trim();
      if(!id) return alert("Paste a Tournament ID first.");

      const snap = await getDoc(doc(db,"tournaments",id));
      if(!snap.exists()) return alert("Not found.");

      const d = snap.data() || {};

      tName.value = d.name || "";
      tCourse.value = d.courseDefault || "tradition";
      tFormat.value = d.format || "stroke";
      tDate.value = d.date || "";
      tOrg.value = d.organizer || "Name";

      tSponsorName.value = d.sponsorName || "";
      tSponsorLogo.value = d.sponsorLogo || "";
      tSponsorUrl.value  = d.sponsorUrl || "";

      adminToken.value = d.adminToken || "";
      buildLinks(id, adminToken.value || "");
      setStatusUI(d.status || "open");
      alert("Loaded.");
    }

    async function saveUpdates(){
      const id = (tId.value || "").trim();
      if(!id) return alert("Missing tournament ID.");

      const payload = {
        name: (tName.value || "Golf Tournament").trim(),
        courseDefault: tCourse.value,
        format: tFormat.value,
        date: (tDate.value || "").trim(),
        organizer: (tOrg.value || "Name").trim(),

        sponsorName: (tSponsorName.value || "").trim(),
        sponsorLogo: (tSponsorLogo.value || "").trim(),
        sponsorUrl: normalizeUrl(tSponsorUrl.value),

        updatedAt: serverTimestamp()
      };

      await setDoc(doc(db,"tournaments",id), payload, { merge:true });

      buildLinks(id, adminToken.value || "");
      alert("Saved!");
    }

    async function closeTournament(){
      const id = (tId.value || "").trim();
      const token = (adminToken.value || "").trim();
      if(!id) return alert("Missing tournament ID.");

      const snap = await getDoc(doc(db,"tournaments",id));
      if(!snap.exists()) return alert("Not found.");

      const d = snap.data() || {};
      if((d.adminToken || "") !== token){
        return alert("Admin token does not match.");
      }

      await setDoc(doc(db,"tournaments",id), { status:"closed", updatedAt: serverTimestamp() }, { merge:true });
      setStatusUI("closed");
      alert("Tournament CLOSED.");
    }

    async function copyText(txt){
      try{
        await navigator.clipboard.writeText(txt);
        alert("Copied!");
      }catch(e){
        alert("Copy blocked. Press and hold to select the link.");
      }
    }

    createBtn.addEventListener("click", createTournament);
    loadBtn.addEventListener("click", loadTournament);
    saveBtn.addEventListener("click", saveUpdates);
    closeBtn.addEventListener("click", closeTournament);

    copyJoin.addEventListener("click", () => copyText(joinLinkEl.textContent || ""));
    copyLb.addEventListener("click", () => copyText(lbLinkEl.textContent || ""));

    // Optional: load by URL ?t=...
    const params = new URLSearchParams(location.search);
    const qid = (params.get("t") || "").trim();
    if(qid){
      tId.value = qid;
      loadTournament();
    }
  </script>

  <script src="./pwa.js"></script>
</body>
</html>
