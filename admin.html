<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Tournament Admin</title>
  <meta name="theme-color" content="#7a4a0b">

  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700;900&display=swap" rel="stylesheet">

  <style>
    :root{ --paper:#e9e2d4; --ink:#111; --border:#7a4a0b; --card:#efe7d7; }
    *{ -webkit-tap-highlight-color: transparent; box-sizing:border-box; }
    body{ margin:0; background:var(--paper); color:var(--ink); font-family:Georgia,'Times New Roman',serif; }
    .wrap{ max-width:900px; margin:0 auto; padding:12px; }
    .card{ background:var(--card); border:3px solid var(--border); border-radius:12px; padding:12px; box-shadow:0 8px 22px rgba(0,0,0,.18); }
    h1{ margin:0 0 8px; font-family:Cinzel,serif; font-weight:900; font-size:20px; }
    .row{ display:grid; gap:10px; margin-top:10px; }
    label{ font-weight:900; font-size:13px; display:block; }
    input, select{
      width:100%; box-sizing:border-box;
      padding:12px 10px; border:2px solid var(--border);
      border-radius:10px; background:#fff; font-size:16px;
      outline:none;
    }
    button{
      border:2px solid var(--border); background:#e7ddcb;
      border-radius:10px; padding:12px 10px; font-weight:900; font-size:16px;
      cursor:pointer;
    }
    button:active{ transform: translateY(1px); }
    .primary{ background:#2f6b2f; color:#fff; }
    .danger{ background:#b6422d; color:#fff; border-color:#7a2b20; }
    .box{
      margin-top:12px; padding:10px; border:2px dashed rgba(0,0,0,.25); border-radius:10px;
      background:rgba(255,255,255,.35);
      word-break: break-word;
    }
    .small{ font-size:13px; opacity:.85; }
    .mono{ font-family: ui-monospace, monospace; }
    .qrRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 10px;
      align-items: start;
    }
    .qrBox{
      background: rgba(255,255,255,.55);
      border: 2px solid rgba(0,0,0,.15);
      border-radius: 10px;
      padding: 10px;
    }
    .qrTitle{ font-weight: 900; font-size: 13px; margin-bottom: 8px; }
    .qrWrap{ display:flex; justify-content:center; }

    /* Sponsor manager */
    .sponsorCard{
      display:grid;
      grid-template-columns: 64px 1fr auto;
      gap:10px;
      align-items:center;
      border:2px solid rgba(0,0,0,.12);
      background:rgba(255,255,255,.55);
      border-radius:12px;
      padding:10px;
    }
    .logoBox{
      width:64px; height:52px;
      border-radius:12px;
      border:2px solid rgba(0,0,0,.12);
      background:rgba(255,255,255,.65);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .logoBox img{ width:100%; height:100%; object-fit:contain; }
    .sponsorName{ font-weight:1000; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .sponsorMeta{ font-size:12px; opacity:.85; margin-top:2px; }
    .sponsorActions{ display:grid; gap:8px; }
    .miniBtn{ padding:8px 10px; font-size:14px; }
    .toggleRow{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:6px; }
    .toggleRow label{ font-size:12px; margin:0; display:flex; gap:8px; align-items:center; }

    .hr{ height:1px; background:rgba(0,0,0,.12); margin:12px 0; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1>Admin Tournament Setup</h1>
      <div class="small">Create a tournament, then share the Join link (QR) + Live Leaderboard link.</div>

      <!-- NAME + COURSE -->
      <div class="row" style="grid-template-columns:1fr 1fr;">
        <label>
          Tournament Name
          <input id="tName" placeholder="Cypresswood Saturday Skins" />
        </label>

        <label>
          Default Course
          <select id="tCourse">
            <option value="tradition">Tradition</option>
            <option value="cypress">Cypress</option>
          </select>
        </label>
      </div>

      <!-- FORMAT + DATE -->
      <div class="row" style="grid-template-columns:1fr 1fr;">
        <label>
          Format of Play
          <select id="tFormat">
            <option value="stroke">Stroke Play</option>
            <option value="scramble">Scramble (Team Score)</option>
            <option value="bestball">Best Ball</option>
            <option value="skins">Skins</option>
          </select>
        </label>

        <label>
          Date (optional)
          <input id="tDate" placeholder="2026-03-01" />
        </label>
      </div>

      <!-- ORGANIZER -->
      <div class="row">
        <label>
          Organizer Name (optional)
          <input id="tOrg" placeholder="Name" />
        </label>
      </div>

      <!-- ENTERPRISE SPONSORS -->
      <div class="box" style="margin-top:12px;">
        <div style="font-family:Cinzel,serif; font-weight:900; font-size:14px;">Sponsors</div>
        <div class="small" style="margin-top:4px;">
          Add multiple sponsors. Upload PNG/JPG. Choose a tier and order. Toggle active.
        </div>

        <div class="row" style="grid-template-columns:1fr 1fr;">
          <label>
            Sponsor Tier
            <select id="spTier">
              <option value="title">Title Sponsor</option>
              <option value="presenting">Presenting</option>
              <option value="partner">Partner</option>
            </select>
          </label>

          <label>
            Sponsor Order (lower shows first)
            <input id="spSort" placeholder="10" inputmode="numeric" />
          </label>
        </div>

        <div class="row" style="grid-template-columns:1fr 1fr;">
          <label>
            Sponsor Name
            <input id="spName" placeholder="Acme Roofing" />
          </label>

          <label>
            Sponsor Website (optional)
            <input id="spWebsite" placeholder="https://sponsor.com" />
          </label>
        </div>

        <div class="row" style="grid-template-columns:1fr 1fr;">
          <label>
            Sponsor Logo (PNG/JPG)
            <input id="spLogoFile" type="file" accept="image/png,image/jpeg" />
          </label>

          <div>
            <div class="small" style="font-weight:900; margin-bottom:6px;">Logo Preview</div>
            <img id="spPreview" alt="Preview"
              style="width:100%; max-width:220px; height:64px; object-fit:contain; background:rgba(255,255,255,.6); border:2px solid rgba(0,0,0,.12); border-radius:12px; padding:6px; display:none;" />
          </div>
        </div>

        <div class="row" style="grid-template-columns:1fr 1fr;">
          <button id="addSponsorBtn">➕ Add Sponsor</button>
          <button id="clearSponsorFormBtn">Clear Sponsor Form</button>
        </div>

        <div class="hr"></div>
        <div class="small" style="font-weight:900;">Sponsor List</div>
        <div id="sponsorList" style="margin-top:10px; display:grid; gap:10px;"></div>
      </div>

      <!-- BUTTONS -->
      <div class="row" style="grid-template-columns:1fr 1fr;">
        <button class="primary" id="createBtn">Create Tournament</button>
        <button id="loadBtn">Load Existing (by ID)</button>
      </div>

      <!-- IDS -->
      <div class="row" style="grid-template-columns:1fr 1fr;">
        <label>
          Tournament ID
          <input id="tId" class="mono"/>
        </label>
        <label>
          Admin Token
          <input id="adminToken" class="mono"/>
        </label>
      </div>

      <!-- LINKS + QRs -->
      <div class="box">
        <div class="small"><b>Join Link</b></div>
        <div id="joinLink" class="mono small"></div>

        <div style="height:10px"></div>

        <div class="small"><b>Leaderboard Link</b></div>
        <div id="lbLink" class="mono small"></div>

        <div class="qrRow">
          <div class="qrBox">
            <div class="qrTitle">Join QR</div>
            <div id="joinQR" class="qrWrap"></div>
          </div>

          <div class="qrBox">
            <div class="qrTitle">Leaderboard QR</div>
            <div id="lbQR" class="qrWrap"></div>
          </div>
        </div>
      </div>

      <div class="row" style="grid-template-columns:1fr 1fr;">
        <button id="copyJoin">Copy Join Link</button>
        <button id="copyLb">Copy Leaderboard Link</button>
      </div>

      <div class="row">
        <button class="danger" id="closeBtn">Close Tournament</button>
      </div>

      <div class="small" style="margin-top:10px;">
        Tip: If sponsor uploads fail, confirm Firebase Storage Rules allow authenticated (anonymous) writes.
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore,
      doc,
      setDoc,
      getDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    import {
      getStorage,
      ref,
      uploadBytes,
      getDownloadURL
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBX2ycbIGEyQh-XgeOXtuhkyBT2XZvsHls",
      authDomain: "cypresswood-tournaments.firebaseapp.com",
      projectId: "cypresswood-tournaments",
      storageBucket: "cypresswood-tournaments.firebasestorage.app",
      messagingSenderId: "162441374966",
      appId: "1:162441374966:web:157285a2d5c39db1e810d7",
      measurementId: "G-HL6Y9CLV8K"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ✅ Auth needed for Storage write (anonymous is fine)
    const auth = getAuth(app);
    await signInAnonymously(auth);

    const storage = getStorage(app);

    const $ = id => document.getElementById(id);

    // Inputs
    const tName = $("tName");
    const tCourse = $("tCourse");
    const tFormat = $("tFormat");
    const tDate = $("tDate");
    const tOrg = $("tOrg");

    const tId = $("tId");
    const adminToken = $("adminToken");

    // Links
    const joinLinkEl = $("joinLink");
    const lbLinkEl = $("lbLink");
    const joinQREl = $("joinQR");
    const lbQREl = $("lbQR");

    // Buttons
    const createBtn = $("createBtn");
    const loadBtn = $("loadBtn");
    const closeBtn = $("closeBtn");
    const copyJoin = $("copyJoin");
    const copyLb = $("copyLb");

    // Sponsor UI
    const spTier = $("spTier");
    const spSort = $("spSort");
    const spName = $("spName");
    const spWebsite = $("spWebsite");
    const spLogoFile = $("spLogoFile");
    const spPreview = $("spPreview");
    const sponsorList = $("sponsorList");
    const addSponsorBtn = $("addSponsorBtn");
    const clearSponsorFormBtn = $("clearSponsorFormBtn");

    // Local sponsor state for this tournament
    let sponsors = [];

    function randId(len=10){
      const chars="abcdefghijklmnopqrstuvwxyz0123456789";
      let s="";
      for(let i=0;i<len;i++) s+=chars[Math.floor(Math.random()*chars.length)];
      return s;
    }

    function baseURL(){
      const url=new URL(location.href);
      url.hash="";
      url.search="";
      url.pathname=url.pathname.replace(/\/admin\.html$/,"/");
      return url.toString();
    }

    function renderQR(el,text){
      el.innerHTML="";
      if(!text) return;
      const holder=document.createElement("div");
      el.appendChild(holder);
      new QRCode(holder,{text,width:180,height:180});
    }

    function buildLinks(id,token){
      const base=baseURL();
      const join=`${base}index.html?t=${id}`;
      const lb=`${base}leaderboard.html?t=${id}&admin=${token}`;
      joinLinkEl.textContent=join;
      lbLinkEl.textContent=lb;
      renderQR(joinQREl,join);
      renderQR(lbQREl,lb);
    }

    async function safeCopy(text){
      try{
        await navigator.clipboard.writeText(text);
        return true;
      }catch(e){
        return false;
      }
    }

    copyJoin.addEventListener("click", async () => {
      const ok = await safeCopy(joinLinkEl.textContent || "");
      if(!ok) alert("Copy blocked. Tap the link and copy manually.");
      else { copyJoin.textContent = "✅ Copied"; setTimeout(()=>copyJoin.textContent="Copy Join Link",900); }
    });

    copyLb.addEventListener("click", async () => {
      const ok = await safeCopy(lbLinkEl.textContent || "");
      if(!ok) alert("Copy blocked. Tap the link and copy manually.");
      else { copyLb.textContent = "✅ Copied"; setTimeout(()=>copyLb.textContent="Copy Leaderboard Link",900); }
    });

    function normalizeUrl(u){
      const s = (u || "").trim();
      if(!s) return "";
      if(/^https?:\/\//i.test(s)) return s;
      return "https://" + s;
    }

    function makeSponsorId(){
      return "sp_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
    }

    spLogoFile.addEventListener("change", () => {
      const f = spLogoFile.files?.[0];
      if (!f){ spPreview.style.display = "none"; return; }
      const url = URL.createObjectURL(f);
      spPreview.src = url;
      spPreview.style.display = "block";
    });

    async function compressImage(file, maxW=900, quality=0.85){
      const isJpg = /jpeg/i.test(file.type) || /jpg/i.test(file.type);
      const imgUrl = URL.createObjectURL(file);

      const img = await new Promise((res, rej) => {
        const i = new Image();
        i.onload = () => res(i);
        i.onerror = rej;
        i.src = imgUrl;
      });

      const scale = Math.min(1, maxW / img.width);
      const w = Math.round(img.width * scale);
      const h = Math.round(img.height * scale);

      const canvas = document.createElement("canvas");
      canvas.width = w;
      canvas.height = h;

      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0, w, h);

      const blob = await new Promise((res) => {
        canvas.toBlob(res, isJpg ? "image/jpeg" : "image/png", quality);
      });

      URL.revokeObjectURL(imgUrl);
      return blob || file;
    }

    async function uploadSponsorLogo(tournamentId, sponsorId, file){
      if (!file) return "";

      const safeName = (file.name || "logo").replace(/[^\w.\-]+/g, "_");
      const path = `tournaments/${tournamentId}/sponsors/${sponsorId}_${Date.now()}_${safeName}`;
      const storageRef = ref(storage, path);

      const blob = await compressImage(file, 900, 0.85);
      await uploadBytes(storageRef, blob, { contentType: file.type });

      return await getDownloadURL(storageRef);
    }

    function renderSponsorList(){
      const sorted = [...sponsors].sort((a,b) => (a.sort ?? 999) - (b.sort ?? 999));

      sponsorList.innerHTML = sorted.map(sp => `
        <div class="sponsorCard">
          <div class="logoBox">
            ${sp.logoUrl ? `<img src="${sp.logoUrl}" alt="Logo">` : `<span style="font-weight:900; opacity:.6;">LOGO</span>`}
          </div>

          <div style="min-width:0;">
            <div class="sponsorName" title="${(sp.name||"").replaceAll('"','&quot;')}">${sp.name || "Sponsor"}</div>
            <div class="sponsorMeta">
              Tier: <b>${sp.tier}</b> • Order: <b>${sp.sort ?? 999}</b>
              ${sp.website ? ` • <span style="opacity:.8;">${sp.website}</span>` : ``}
            </div>

            <div class="toggleRow">
              <label><input type="checkbox" data-act="${sp.id}" ${sp.active ? "checked" : ""}/> Active</label>
              <button class="miniBtn" data-up="${sp.id}">↑</button>
              <button class="miniBtn" data-down="${sp.id}">↓</button>
            </div>
          </div>

          <div class="sponsorActions">
            <button class="miniBtn" data-edit="${sp.id}">Edit</button>
            <button class="miniBtn danger" data-del="${sp.id}">Remove</button>
          </div>
        </div>
      `).join("");

      sponsorList.querySelectorAll("[data-del]").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-del");
          sponsors = sponsors.filter(s => s.id !== id);
          renderSponsorList();
        });
      });

      sponsorList.querySelectorAll("[data-edit]").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-edit");
          const sp = sponsors.find(s => s.id === id);
          if (!sp) return;

          spTier.value = sp.tier || "partner";
          spSort.value = String(sp.sort ?? 10);
          spName.value = sp.name || "";
          spWebsite.value = sp.website || "";
          spPreview.src = sp.logoUrl || "";
          spPreview.style.display = sp.logoUrl ? "block" : "none";
          spLogoFile.value = ""; // cannot set programmatically

          alert("Sponsor loaded into form. Update fields and click ➕ Add Sponsor to add another (or remove the old one).");
        });
      });

      sponsorList.querySelectorAll("[data-act]").forEach(chk => {
        chk.addEventListener("change", () => {
          const id = chk.getAttribute("data-act");
          const sp = sponsors.find(s => s.id === id);
          if (sp) sp.active = chk.checked;
        });
      });

      sponsorList.querySelectorAll("[data-up]").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-up");
          const sp = sponsors.find(s => s.id === id);
          if (!sp) return;
          sp.sort = (Number(sp.sort ?? 10) || 10) - 1;
          renderSponsorList();
        });
      });

      sponsorList.querySelectorAll("[data-down]").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-down");
          const sp = sponsors.find(s => s.id === id);
          if (!sp) return;
          sp.sort = (Number(sp.sort ?? 10) || 10) + 1;
          renderSponsorList();
        });
      });
    }

    function clearSponsorForm(){
      spTier.value = "partner";
      spSort.value = "10";
      spName.value = "";
      spWebsite.value = "";
      spLogoFile.value = "";
      spPreview.style.display = "none";
    }

    clearSponsorFormBtn.addEventListener("click", clearSponsorForm);

    addSponsorBtn.addEventListener("click", async () => {
      const tid = (tId.value || "").trim();
      if (!tid){
        alert("Create or load a tournament first (needs Tournament ID).");
        return;
      }

      const name = (spName.value || "").trim();
      if (!name){
        alert("Sponsor name is required.");
        return;
      }

      const id = makeSponsorId();
      const tier = (spTier.value || "partner").trim();
      const sort = Number(spSort.value || 10) || 10;
      const website = normalizeUrl(spWebsite.value || "");

      let logoUrl = "";
      const file = spLogoFile.files?.[0];
      if (file){
        try{
          logoUrl = await uploadSponsorLogo(tid, id, file);
        }catch(e){
          console.error(e);
          alert("Logo upload failed. Check Storage Rules and try again.");
          return;
        }
      }

      sponsors.push({
        id, tier, sort,
        name,
        website,
        logoUrl,
        active: true
      });

      renderSponsorList();
      clearSponsorForm();
    });

    function deriveLegacySponsorFromSponsors(){
      // Keep backwards compatibility for older leaderboard/scorecard:
      const active = sponsors.filter(s => s && s.active);
      if (!active.length) return { sponsorName:"", sponsorLogo:"", sponsorUrl:"" };

      const sorted = [...active].sort((a,b) => (a.sort ?? 999) - (b.sort ?? 999));
      const hero = sorted.find(s => s.tier === "title") || sorted[0];
      return {
        sponsorName: hero?.name || "",
        sponsorLogo: hero?.logoUrl || "",
        sponsorUrl: hero?.website || ""
      };
    }

    async function createTournament(){
      const id = randId(10);
      const token = randId(18);

      // new tournament id is known now — store it so sponsor uploads can use it
      tId.value = id;
      adminToken.value = token;

      const legacy = deriveLegacySponsorFromSponsors();

      const payload = {
        name: tName.value.trim(),
        courseDefault: tCourse.value,
        format: tFormat.value,
        date: tDate.value.trim(),
        organizer: (tOrg.value || "").trim(),

        // ✅ enterprise sponsors
        sponsors: sponsors || [],

        // ✅ legacy single sponsor fields (backward compatible)
        sponsorName: legacy.sponsorName,
        sponsorLogo: legacy.sponsorLogo,
        sponsorUrl: legacy.sponsorUrl,

        status: "open",
        adminToken: token,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      };

      await setDoc(doc(db, "tournaments", id), payload);
      buildLinks(id, token);
      alert("Tournament created!");
    }

    async function loadTournament(){
      const id = tId.value.trim();
      if(!id) return alert("Paste a Tournament ID first.");

      const snap = await getDoc(doc(db, "tournaments", id));
      if(!snap.exists()) return alert("Not found.");

      const d = snap.data() || {};

      tName.value = d.name || "";
      tCourse.value = d.courseDefault || "tradition";
      tFormat.value = d.format || "stroke";
      tDate.value = d.date || "";
      tOrg.value = d.organizer || "";
      adminToken.value = d.adminToken || "";

      // ✅ load sponsor list
      sponsors = Array.isArray(d.sponsors) ? d.sponsors : [];
      renderSponsorList();

      buildLinks(id, d.adminToken || "");
    }

    async function closeTournament(){
      const id = tId.value.trim();
      if(!id) return alert("Enter Tournament ID first.");
      await setDoc(doc(db, "tournaments", id), { status:"closed", updatedAt: serverTimestamp() }, { merge:true });
      alert("Tournament CLOSED.");
    }

    createBtn.addEventListener("click", createTournament);
    loadBtn.addEventListener("click", loadTournament);
    closeBtn.addEventListener("click", closeTournament);

    // Default sponsor form values
    clearSponsorForm();
  </script>
</body>
</html>
