<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Live Leaderboard</title>

  <meta name="theme-color" content="#7a4a0b" />
  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="apple-touch-icon" href="./assets/icon-192.png" />
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700;900&display=swap" rel="stylesheet" />

  <style>
    :root{
      --paper:#e9e2d4;
      --card:#efe7d7;
      --ink:#111;
      --muted:rgba(0,0,0,.65);
      --border:#7a4a0b;
      --line:rgba(0,0,0,.12);
      --gold:#caa44a;
      --silver:#b8b8b8;
      --bronze:#b07a4d;
      --green:#2f6b2f;
      --danger:#b6422d;
    }

    *{ -webkit-tap-highlight-color: transparent; box-sizing:border-box; }
    body{ margin:0; background:var(--paper); color:var(--ink); font-family: Georgia, "Times New Roman", serif; }

    .wrap{ max-width: 980px; margin:0 auto; padding: 10px 10px 24px; }
    .card{
      background: var(--card);
      border: 3px solid var(--border);
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 10px 26px rgba(0,0,0,.18);
    }

    /* Top banner */
    .top{
      position: sticky;
      top: 0;
      z-index: 50;
      background: linear-gradient(to bottom, rgba(239,231,215,1), rgba(239,231,215,.92));
      backdrop-filter: blur(6px);
      border-bottom: 1px solid var(--line);
    }

    .courseHeader{
      width: 100%;
      display: block;
      max-height: 110px;
      object-fit: contain;
      background: var(--card);
      border-bottom: 1px solid var(--line);
    }

    .titleRow{
      padding: 10px 12px 8px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
    }

    .titleBlock h1{
      margin:0;
      font-family: Cinzel, serif;
      font-weight: 900;
      letter-spacing: .4px;
      font-size: 18px;
      line-height: 1.15;
    }
    .titleBlock .sub{
      margin-top: 4px;
      font-size: 12px;
      color: var(--muted);
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 2px solid rgba(0,0,0,.14);
      background: rgba(255,255,255,.52);
      font-weight: 900;
      font-size: 12px;
      white-space: nowrap;
    }

    .bar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      padding: 10px 12px 12px;
      align-items:center;
      justify-content: space-between;
      border-top: 1px solid var(--line);
    }

    .btnRow{
      display:flex;
      gap:10px;
      flex-wrap: wrap;
      align-items:center;
    }

    button, .btn{
      border: 2px solid var(--border);
      background: #e7ddcb;
      border-radius: 10px;
      padding: 10px 12px;
      font-weight: 900;
      font-size: 14px;
      cursor:pointer;
      text-decoration:none;
      color: var(--ink);
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    button:active, .btn:active{ transform: translateY(1px); }

    .btnPrimary{
      background: var(--green);
      color: #fff;
      border-color: rgba(0,0,0,.2);
    }

    /* Sponsor hero */
    #sponsorHero{
      display:none;
      margin: 10px 12px 0;
      border:2px solid rgba(0,0,0,.14);
      border-radius:12px;
      background:rgba(255,255,255,.55);
      padding:10px 12px;
      cursor:pointer;
    }
    #sponsorHero:active{ transform: translateY(1px); }
    #sponsorHeroTitle{ font-family:Cinzel,serif; font-weight:900; font-size:13px; opacity:.9; }
    #sponsorHeroRow{ display:flex; align-items:center; gap:10px; margin-top:8px; }
    #sponsorHeroLogo{
      width:44px; height:44px; border-radius:10px; object-fit:cover;
      border:2px solid rgba(0,0,0,.12); background:rgba(0,0,0,.06);
      display:none;
    }
    #sponsorHeroName{ font-weight:900; font-size:16px; }

    /* Board */
    .board{
      padding: 12px;
    }

    .hdr{
      display:grid;
      grid-template-columns: 62px 1fr 110px;
      gap:10px;
      padding: 10px 10px;
      border: 2px solid rgba(0,0,0,.12);
      border-radius: 12px;
      background: rgba(255,255,255,.44);
      font-family: Cinzel, serif;
      font-weight: 900;
      font-size: 12px;
      letter-spacing:.4px;
      margin-bottom: 10px;
    }
    .hdr div{ opacity:.9; }
    .hdr .right{ text-align:right; }

    .list{ display:grid; gap:10px; }

    /* Each row card */
    .row{
      display:grid;
      grid-template-columns: 62px 1fr 110px;
      gap:10px;
      align-items: center;
      padding: 12px 10px;
      border-radius: 14px;
      border: 2px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.55);
      box-shadow: 0 8px 18px rgba(0,0,0,.10);
      transition: transform .45s ease, box-shadow .45s ease;
      will-change: transform;
    }

    .row.leader{
      border-color: rgba(202,164,74,.75);
      box-shadow: 0 0 0 3px rgba(202,164,74,.18), 0 12px 24px rgba(0,0,0,.14);
      background: linear-gradient(to right, rgba(255,255,255,.72), rgba(255,255,255,.52));
    }

    .rankBadge{
      width: 62px;
      height: 62px;
      border-radius: 16px;
      display:flex;
      flex-direction: column;
      align-items:center;
      justify-content:center;
      border: 2px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.56);
    }

    .rankNum{
      font-family: Cinzel, serif;
      font-weight: 900;
      font-size: 18px;
      line-height: 1;
    }
    .rankMove{
      margin-top: 4px;
      font-size: 12px;
      font-weight: 900;
      opacity:.9;
    }
    .up{ color: #1f7a1f; }
    .down{ color: #9b2d2d; }
    .same{ color: rgba(0,0,0,.55); }

    .who .name{
      font-weight: 1000;
      font-size: 16px;
      line-height: 1.1;
    }
    .who .meta{
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.50);
      font-weight: 900;
      font-size: 12px;
      color: rgba(0,0,0,.75);
      white-space: nowrap;
    }

    .scoreBox{
      text-align:right;
      display:flex;
      flex-direction: column;
      align-items:flex-end;
      gap: 4px;
    }

    .bigScore{
      font-family: Cinzel, serif;
      font-weight: 900;
      font-size: 20px;
      line-height: 1;
      letter-spacing: .3px;
    }
    .smallScore{
      font-size: 12px;
      color: var(--muted);
      font-weight: 900;
    }

    /* Top 3 styling */
    .row.top1 .rankBadge{ border-color: rgba(202,164,74,.65); }
    .row.top2 .rankBadge{ border-color: rgba(184,184,184,.9); }
    .row.top3 .rankBadge{ border-color: rgba(176,122,77,.8); }

    /* ESPN-ish motion */
    .flash{
      animation: flash 900ms ease-out 1;
    }
    @keyframes flash{
      0%{ box-shadow: 0 0 0 0 rgba(47,107,47,.0), 0 8px 18px rgba(0,0,0,.10); }
      40%{ box-shadow: 0 0 0 4px rgba(47,107,47,.18), 0 12px 24px rgba(0,0,0,.14); }
      100%{ box-shadow: 0 0 0 0 rgba(47,107,47,.0), 0 8px 18px rgba(0,0,0,.10); }
    }

    /* TV Mode */
    .tvHint{
      display:none;
      padding: 10px 12px;
      border-top: 1px solid var(--line);
      font-size: 12px;
      color: var(--muted);
    }
    body.tv .tvHint{ display:block; }
    body.tv .wrap{ max-width: 1200px; }
    body.tv .courseHeader{ max-height: 140px; }

    /* Footer links */
    .footer{
      padding: 14px 12px 16px;
      border-top: 1px solid var(--line);
      text-align:center;
      font-size: 12px;
      color: rgba(0,0,0,.68);
    }
    .footer a{ color: rgba(0,0,0,.75); font-weight: 900; text-decoration: none; }
    .footer a:active{ opacity: .7; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <img id="courseHeader" class="courseHeader" src="./assets/cypresswood_header.png" alt="Course Header" />

        <div class="titleRow">
          <div class="titleBlock">
            <h1 id="pageTitle">Cypresswood Golf Club ‚Ä¢ Live Leaderboard</h1>
            <div class="sub" id="pageMeta">Loading‚Ä¶</div>
          </div>

          <div class="pill" id="statusPill">‚õ≥Ô∏è LIVE</div>
        </div>

        <div id="sponsorHero" role="button" aria-label="Tournament Sponsor">
          <div id="sponsorHeroTitle">Tournament Sponsor</div>
          <div id="sponsorHeroRow">
            <img id="sponsorHeroLogo" alt="Sponsor Logo" />
            <div id="sponsorHeroName"></div>
          </div>
        </div>

        <div class="bar">
          <div class="btnRow">
            <button id="refreshBtn">üîÑ Refresh</button>
            <a id="joinBtn" class="btn btnPrimary" href="./index.html">üë• Join</a>
            <button id="copyBtn">üìã Copy Link</button>
            <button id="tvBtn">üì∫ TV Mode</button>
          </div>
        </div>

        <div class="tvHint" id="tvHint">
          TV Mode ON ‚Ä¢ Auto-scroll + Auto-refresh. Add <b>?tv=1</b> to the URL for display screens.
        </div>
      </div>

      <div class="board">
        <div class="hdr">
          <div>RANK</div>
          <div>PLAYER / TEAM</div>
          <div class="right" id="hdrRight">SCORE</div>
        </div>

        <div class="list" id="list"></div>
      </div>

      <div class="footer">
        <div>
          <a href="./privacy.html" target="_blank" rel="noopener">Privacy</a>
          &nbsp;‚Ä¢&nbsp;
          <a href="./terms.html" target="_blank" rel="noopener">Terms</a>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, doc, getDoc, collection, onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // ===== Firebase config (same project) =====
    const firebaseConfig = {
      apiKey: "AIzaSyBX2ycbIGEyQh-XgeOXtuhkyBT2XZvsHls",
      authDomain: "cypresswood-tournaments.firebaseapp.com",
      projectId: "cypresswood-tournaments",
      storageBucket: "cypresswood-tournaments.firebasestorage.app",
      messagingSenderId: "162441374966",
      appId: "1:162441374966:web:157285a2d5c39db1e810d7",
      measurementId: "G-HL6Y9CLV8K"
    };

    // ===== Course par/hcp data for relative + playoff =====
    const COURSE_TRADITION = {
      id:"tradition",
      title:"Tradition Course",
      headerImg:"./assets/cypresswood_header.png",
      parFront:[4,4,3,4,5,4,5,3,4],
      parBack:[4,3,5,4,3,4,4,4,5],
      hcpFront:[7,17,11,1,3,13,9,15,5],
      hcpBack:[14,8,10,6,18,12,2,16,4],
    };

    const COURSE_CYPRESS = {
      id:"cypress",
      title:"Cypress Course",
      headerImg:"./assets/cypress_header.png",
      parFront:[5,4,4,4,3,4,3,5,4],
      parBack:[4,4,4,4,3,5,3,5,4],
      hcpFront:[3,13,11,7,15,9,17,1,5],
      hcpBack:[6,10,12,14,18,2,16,4,8],
    };

    const COURSES = { tradition: COURSE_TRADITION, cypress: COURSE_CYPRESS };

    // ===== DOM =====
    const $ = (id) => document.getElementById(id);
    const listEl = $("list");
    const pageTitle = $("pageTitle");
    const pageMeta = $("pageMeta");
    const statusPill = $("statusPill");
    const joinBtn = $("joinBtn");
    const copyBtn = $("copyBtn");
    const refreshBtn = $("refreshBtn");
    const tvBtn = $("tvBtn");
    const tvHint = $("tvHint");
    const hdrRight = $("hdrRight");
    const courseHeader = $("courseHeader");

    const sponsorHero = $("sponsorHero");
    const sponsorHeroLogo = $("sponsorHeroLogo");
    const sponsorHeroName = $("sponsorHeroName");

    // ===== URL params =====
    const params = new URLSearchParams(location.search);
    const tournamentId = (params.get("t") || "").trim();
    const tvMode = params.get("tv") === "1";

    if(tvMode){
      document.body.classList.add("tv");
      tvBtn.textContent = "üì∫ TV Mode ON";
      tvHint.style.display = "block";
    }

    // ===== helpers =====
    const escapeHtml = (s="") => String(s)
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");

    function normalizeUrl(u){
      const s = (u || "").trim();
      if(!s) return "";
      if(/^https?:\/\//i.test(s)) return s;
      return "https://" + s;
    }

    function buildParArray(courseId){
      const c = COURSES[courseId] || COURSE_TRADITION;
      return [...c.parFront, ...c.parBack];
    }

    function computeRelativeToPar(total, courseId){
      const pars = buildParArray(courseId);
      const parTotal = pars.reduce((a,b)=>a+(Number(b)||0),0);
      return total - parTotal;
    }

    function formatRel(rel){
      if(rel === 0) return "E";
      if(rel < 0) return String(rel);
      return "+" + rel;
    }

    function buildHcpRankOrder(courseId){
      const c = COURSES[courseId] || COURSE_TRADITION;
      const byHole = [];
      for(let i=0;i<9;i++){
        byHole.push({ hole:i+1, rank: Number(c.hcpFront[i]) || 99 });
      }
      for(let i=0;i<9;i++){
        byHole.push({ hole:i+10, rank: Number(c.hcpBack[i]) || 99 });
      }
      byHole.sort((a,b)=>a.rank-b.rank);
      return byHole.map(x=>x.hole); // hardest first (rank 1)
    }

    // scoresFlat accessor
    function getScoreFlat(sub, playerIndex, hole){
      const k = `p${playerIndex}_h${hole}`;
      const v = sub.scoresFlat?.[k];
      const n = parseInt(v,10);
      return Number.isFinite(n) ? n : 0;
    }

    // THRU = how many holes have a number in p0 row (scramble) or bestball computed row
    function computeThru(sub, fmt){
      let filled = 0;
      for(let h=1; h<=18; h++){
        const v = sub.scoresFlat?.[`p0_h${h}`];
        const n = parseInt(v,10);
        if(Number.isFinite(n) && n > 0) filled++;
      }
      return filled;
    }

    // Scorecard playoff tiebreak: compare hole score on hardest handicap hole, then next...
    function playoffCompare(a,b,fmt,courseId){
      const order = buildHcpRankOrder(courseId);
      // Use p0 for scramble; otherwise compare player0 total-by-hole
      for(const hole of order){
        const as = getScoreFlat(a, 0, hole);
        const bs = getScoreFlat(b, 0, hole);
        if(as !== bs) return as - bs; // lower wins
      }
      return 0;
    }

    // Skins: winner per hole (unique low score) uses p0 row (team score) as requested
    function computeSkinsForTeams(subs){
      const skins = {};
      subs.forEach(s => skins[s.id] = 0);

      for(let h=1; h<=18; h++){
        let best = Infinity;
        subs.forEach(s=>{
          const sc = getScoreFlat(s,0,h);
          if(sc > 0) best = Math.min(best, sc);
        });
        if(!Number.isFinite(best) || best === Infinity) continue;

        const winners = subs.filter(s => getScoreFlat(s,0,h) === best);
        if(winners.length === 1){
          skins[winners[0].id] += 1;
        }
      }
      return skins;
    }

    // ===== UI motion state =====
    const prevRank = new Map(); // deviceId => rank

    function rankMoveText(oldRank, newRank){
      if(oldRank == null) return { cls:"same", txt:"‚Ä¢" };
      const d = oldRank - newRank;
      if(d > 0) return { cls:"up", txt:`‚ñ≤${d}` };
      if(d < 0) return { cls:"down", txt:`‚ñº${Math.abs(d)}` };
      return { cls:"same", txt:"‚Ä¢" };
    }

    function applySponsorUI(t){
      const name = (t.sponsorName || "").trim();
      const logo = (t.sponsorLogo || "").trim();
      const url = normalizeUrl(t.sponsorUrl || "");

      if(!name && !logo){
        sponsorHero.style.display = "none";
        sponsorHero.onclick = null;
        return;
      }

      sponsorHero.style.display = "block";
      sponsorHeroName.textContent = name || "Tournament Sponsor";

      if(logo){
        sponsorHeroLogo.src = logo;
        sponsorHeroLogo.style.display = "block";
      }else{
        sponsorHeroLogo.style.display = "none";
      }

      sponsorHero.style.cursor = url ? "pointer" : "default";
      sponsorHero.onclick = () => { if(url) window.open(url, "_blank"); };
    }

    function setHeaderForCourse(courseId){
      const c = COURSES[courseId] || COURSE_TRADITION;
      courseHeader.src = c.headerImg;
      courseHeader.alt = c.title + " Header";
    }

    // ===== Render =====
    function render(subs, fmt, courseId){
      // header right label
      hdrRight.textContent = (fmt === "skins") ? "SKINS" : "TO PAR";

      // Compute totals + rel + thru
      subs.forEach(s=>{
        const tot = Number(s.totals?.[0]?.tot || s.totals?.[0]?.total || s.totals?.[0]?.t || s.totals?.[0]?.tot) || Number(s.totals?.[0]?.tot) || 0;
        // In your writes, totals is an array of objects: [{out,inn,tot}, ...]
        const first = s.totals?.[0];
        s.__total = Number(first?.tot || 0) || 0;
        s.__rel = computeRelativeToPar(s.__total, courseId);
        s.__thru = computeThru(s, fmt);
      });

      // Sort
      if(fmt === "skins"){
        const skinsMap = computeSkinsForTeams(subs);
        subs.forEach(s=> s.__skins = skinsMap[s.id] || 0);
        subs.sort((a,b)=>{
          if(b.__skins !== a.__skins) return b.__skins - a.__skins;
          if(a.__total !== b.__total) return a.__total - b.__total;
          return playoffCompare(a,b,fmt,courseId);
        });
      } else {
        subs.sort((a,b)=>{
          if(a.__total !== b.__total) return a.__total - b.__total;
          return playoffCompare(a,b,fmt,courseId);
        });
      }

      // Render rows
      listEl.innerHTML = "";
      subs.forEach((sub, idx)=>{
        const rank = idx + 1;
        const old = prevRank.get(sub.id);
        const mv = rankMoveText(old, rank);
        prevRank.set(sub.id, rank);

        // MAIN name logic:
        // - show Group as big name if present (team)
        // - otherwise show playerName
        // - show the other one beneath (so you never "lose" the name)
        const group = (sub.group || "").trim();
        const player = (sub.playerName || "").trim();
        const bigName = group || player || "Player";
        const smallLine = group && player ? `Keeper: ${player}` : (sub.startHole ? `Start: ${sub.startHole}` : "");

        const scoreBig = (fmt === "skins") ? String(sub.__skins || 0) : formatRel(sub.__rel);
        const scoreSmall = (fmt === "skins")
          ? `Tot ${sub.__total} ‚Ä¢ Thru ${sub.__thru}`
          : `Tot ${sub.__total} ‚Ä¢ Thru ${sub.__thru}`;

        const row = document.createElement("div");
        row.className = "row";
        if(rank === 1) row.classList.add("leader","top1");
        if(rank === 2) row.classList.add("top2");
        if(rank === 3) row.classList.add("top3");
        if(old != null && old !== rank) row.classList.add("flash");

        row.innerHTML = `
          <div class="rankBadge">
            <div class="rankNum">${rank}</div>
            <div class="rankMove ${mv.cls}">${mv.txt}</div>
          </div>

          <div class="who">
            <div class="name">${escapeHtml(bigName)}</div>
            <div class="meta">
              ${smallLine ? `<span class="chip">üë§ ${escapeHtml(smallLine)}</span>` : ""}
              ${sub.courseId ? `<span class="chip">‚õ≥Ô∏è ${escapeHtml(sub.courseId)}</span>` : ""}
              ${sub.updatedAt?.toDate ? `<span class="chip">üïí Updated</span>` : ""}
            </div>
          </div>

          <div class="scoreBox">
            <div class="bigScore">${escapeHtml(scoreBig)}</div>
            <div class="smallScore">${escapeHtml(scoreSmall)}</div>
          </div>
        `;

        listEl.appendChild(row);
      });
    }

    // ===== TV auto scroll =====
    let tvScrollTimer = null;
    function startTvAutoScroll(){
      stopTvAutoScroll();
      const stepPx = 1;       // scroll speed
      const tickMs = 18;      // smooth
      tvScrollTimer = setInterval(()=>{
        const max = document.documentElement.scrollHeight - window.innerHeight;
        if(max <= 0) return;
        const y = window.scrollY + stepPx;
        if(y >= max){
          window.scrollTo({ top: 0, behavior: "instant" });
        }else{
          window.scrollTo({ top: y, behavior: "instant" });
        }
      }, tickMs);
    }
    function stopTvAutoScroll(){
      if(tvScrollTimer) clearInterval(tvScrollTimer);
      tvScrollTimer = null;
    }

    // ===== Init =====
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    if(!tournamentId){
      pageMeta.textContent = "Missing tournament id. Use ?t=TOURNAMENT_ID";
      statusPill.textContent = "‚ö†Ô∏è NO TOURNAMENT";
    }else{
      joinBtn.href = `./index.html?t=${encodeURIComponent(tournamentId)}`;

      // Copy link
      copyBtn.addEventListener("click", async () => {
        try{
          await navigator.clipboard.writeText(location.href);
          copyBtn.textContent = "‚úÖ Copied";
          setTimeout(()=>copyBtn.textContent="üìã Copy Link", 1200);
        }catch(e){
          alert("Copy blocked. Long-press the URL and copy.");
        }
      });

      // Toggle TV mode
      tvBtn.addEventListener("click", ()=>{
        const u = new URL(location.href);
        if(u.searchParams.get("tv") === "1"){
          u.searchParams.delete("tv");
        }else{
          u.searchParams.set("tv","1");
        }
        location.href = u.toString();
      });

      // Refresh button (soft refresh)
      refreshBtn.addEventListener("click", ()=>{
        statusPill.textContent = "üîÑ REFRESHING‚Ä¶";
        setTimeout(()=>statusPill.textContent="‚õ≥Ô∏è LIVE", 700);
      });

      // Load tournament settings once, then live-listen submissions
      let tournamentFormat = "stroke";
      let courseId = "tradition";

      const tRef = doc(db, "tournaments", tournamentId);
      const subsRef = collection(db, "tournaments", tournamentId, "submissions");

      const tSnap = await getDoc(tRef);
      if(tSnap.exists()){
        const t = tSnap.data() || {};
        tournamentFormat = (t.format || "stroke").toString().trim();
        courseId = (t.courseDefault || "tradition").toString().trim();
        if(!COURSES[courseId]) courseId = "tradition";

        setHeaderForCourse(courseId);
        applySponsorUI(t);

        const niceFormat =
          tournamentFormat === "scramble" ? "Scramble" :
          tournamentFormat === "bestball" ? "Best Ball" :
          tournamentFormat === "skins" ? "Skins" :
          "Stroke Play";

        pageMeta.textContent = `${escapeHtml(t.name || "Tournament")} ‚Ä¢ ${niceFormat} ‚Ä¢ ${COURSES[courseId].title}`;
      }else{
        pageMeta.textContent = `Tournament: ${tournamentId}`;
      }

      // Live listen
      onSnapshot(subsRef, (snap)=>{
        const subs = [];
        snap.forEach(d=>{
          const data = d.data() || {};
          subs.push({ id:d.id, ...data });
        });

        // Filter out empty docs if needed
        render(subs, tournamentFormat, courseId);

        statusPill.textContent = "‚õ≥Ô∏è LIVE";
      }, (err)=>{
        console.error(err);
        statusPill.textContent = "‚ö†Ô∏è ERROR";
        pageMeta.textContent = "Could not load leaderboard (Firestore rules or network).";
      });

      // TV extras
      if(tvMode){
        startTvAutoScroll();
        // optional periodic hard refresh for TVs
        setInterval(()=>location.reload(), 1000 * 60 * 5); // every 5 min
      }
    }
  </script>

  <script src="./pwa.js"></script>
</body>
</html>
