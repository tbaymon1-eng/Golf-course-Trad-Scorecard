<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Live Leaderboard</title>
  <meta name="theme-color" content="#7a4a0b">

  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --paper:#e9e2d4;
      --ink:#111;
      --border:#7a4a0b;
      --card:#efe7d7;
      --panel:#f6f0e4;
      --soft:rgba(0,0,0,.08);
      --soft2:rgba(0,0,0,.12);
    }
    *{ -webkit-tap-highlight-color: transparent; }
    body{
      margin:0;
      background:var(--paper);
      color:var(--ink);
      font-family: Georgia, 'Times New Roman', serif;
    }
    .wrap{ max-width:980px; margin:0 auto; padding:12px; }
    .card{
      background:var(--card);
      border:3px solid var(--border);
      border-radius:12px;
      overflow:hidden;
      box-shadow:0 8px 22px rgba(0,0,0,.18);
    }

    /* course header image */
    .topHeaderImg{
      width:100%;
      max-height:120px;
      object-fit:contain;
      display:block;
      background: var(--card);
      border-bottom:1px solid var(--soft);
    }

    .top{ padding:12px; }
    h1{
      margin:0;
      font-family:Cinzel,serif;
      font-weight:900;
      letter-spacing:.6px;
      font-size:26px;
    }
    .meta{
      margin-top:6px;
      opacity:.85;
      font-size:14px;
    }
    .clubLine{
      margin-top:6px;
      font-family:Cinzel,serif;
      font-weight:900;
      letter-spacing:.4px;
      font-size:18px;
      text-transform:uppercase;
    }

    .bar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin-top:12px;
    }
    .pill{
      border:2px solid rgba(0,0,0,.16);
      background:rgba(255,255,255,.55);
      border-radius:999px;
      padding:8px 12px;
      font-weight:900;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }

    button, .btn{
      border:2px solid var(--border);
      background:#e7ddcb;
      border-radius:10px;
      padding:12px 12px;
      font-weight:900;
      font-size:16px;
      cursor:pointer;
      text-decoration:none;
      color:inherit;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    button:active, .btn:active{ transform: translateY(1px); }
    .primary{ background:#2f6b2f; color:#fff; }
    .tvBtn{ background:#202020; color:#fff; border-color:#000; }
    .copyBtn{ min-width:260px; justify-content:center; }

    /* sponsor hero */
    #sponsorHero{
      display:none;
      margin-top:12px;
      border-radius:12px;
      border:2px solid var(--soft2);
      background:rgba(255,255,255,.60);
      padding:12px;
      cursor:pointer;
    }
    #sponsorHero:active{ transform: translateY(1px); }
    #sponsorHeroTitle{
      font-family:Cinzel,serif;
      font-weight:900;
      font-size:14px;
      letter-spacing:.4px;
      text-transform:uppercase;
      opacity:.92;
    }
    #sponsorHeroRow{
      display:flex;
      align-items:center;
      gap:12px;
      margin-top:10px;
    }
    #sponsorHeroLogo{
      width:56px; height:56px;
      border-radius:12px;
      object-fit:cover;
      border:2px solid rgba(0,0,0,.12);
      background:rgba(0,0,0,.06);
      display:none;
      flex:none;
    }
    #sponsorHeroName{
      font-weight:900;
      font-size:20px;
    }
    #sponsorHeroHint{
      margin-top:6px;
      font-size:12px;
      opacity:.75;
    }

    /* sections */
    .section{
      margin-top:12px;
      background: var(--panel);
      border-top:1px solid var(--soft);
      padding:12px;
    }
    .sectionHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border:2px solid rgba(0,0,0,.12);
      border-radius:12px;
      background:rgba(255,255,255,.55);
    }
    .sectionTitle{
      font-family:Cinzel,serif;
      font-weight:900;
      font-size:20px;
      letter-spacing:.4px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .sectionSub{
      opacity:.85;
      font-size:14px;
    }

    /* top cards */
    .topGrid{
      display:grid;
      grid-template-columns:1fr;
      gap:12px;
      margin-top:12px;
    }
    .teamCard{
      border:2px solid rgba(0,0,0,.12);
      border-radius:16px;
      background:rgba(255,255,255,.65);
      padding:14px;
      cursor:pointer;
      position:relative;
    }
    .teamCard:active{ transform: translateY(1px); }

    .rankBadge{
      font-family:Cinzel,serif;
      font-weight:900;
      font-size:18px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .teamName{
      font-family: Georgia, 'Times New Roman', serif;
      font-weight:900;
      font-size:34px;
      margin-top:10px;
      line-height:1.05;
    }
    .teamScore{
      font-family: Georgia, 'Times New Roman', serif;
      font-weight:900;
      font-size:44px;
      margin-top:6px;
    }
    .teamMeta{
      margin-top:8px;
      opacity:.85;
      font-size:16px;
    }

    /* all teams table */
    .tableWrap{
      margin-top:12px;
      overflow:auto;
      border-radius:12px;
      border:2px solid rgba(0,0,0,.12);
      background:rgba(255,255,255,.45);
    }
    table{ width:100%; border-collapse:collapse; min-width:700px; }
    th, td{
      border:1px solid rgba(0,0,0,.18);
      padding:12px;
      text-align:left;
      font-size:16px;
    }
    th{
      background:rgba(255,255,255,.55);
      font-family:Cinzel,serif;
      font-weight:900;
      font-size:16px;
      position:sticky;
      top:0;
      z-index:2;
    }
    tr.rowTap{ cursor:pointer; }
    tr.rowTap:hover{ background:rgba(255,255,255,.35); }
    .muted{ opacity:.75; font-size:14px; }

    /* modal - golf styled */
    .modalOverlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:9999;
    }
    .modal{
      width:min(780px, 96vw);
      border-radius:18px;
      border:3px solid rgba(255,255,255,.18);
      background: linear-gradient(180deg, rgba(239,231,215,.98), rgba(245,240,228,.98));
      box-shadow:0 18px 60px rgba(0,0,0,.35);
      overflow:hidden;
    }
    .modalTop{
      padding:14px 16px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      border-bottom:1px solid rgba(0,0,0,.12);
      background:rgba(255,255,255,.40);
    }
    .modalTitle{
      font-family:Cinzel,serif;
      font-weight:900;
      font-size:18px;
      letter-spacing:.4px;
    }
    .modalClose{
      border:2px solid var(--border);
      background:#e7ddcb;
      border-radius:12px;
      padding:10px 12px;
      font-weight:900;
      cursor:pointer;
    }
    .modalBody{ padding:14px 16px 16px; }
    .scoreMiniRow{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .bigScore{
      font-family: Georgia, 'Times New Roman', serif;
      font-weight:900;
      font-size:40px;
    }
    .miniMeta{
      font-size:14px;
      opacity:.82;
      text-align:right;
      line-height:1.2;
    }
    .holesGrid{
      margin-top:12px;
      display:grid;
      grid-template-columns: repeat(9, 1fr);
      gap:8px;
    }
    .holeChip{
      border:2px solid rgba(0,0,0,.12);
      border-radius:14px;
      background:rgba(255,255,255,.65);
      padding:10px 8px;
      text-align:center;
    }
    .holeNum{
      font-family:Cinzel,serif;
      font-weight:900;
      font-size:12px;
      opacity:.8;
    }
    .holeVal{
      font-weight:900;
      font-size:20px;
      margin-top:2px;
    }
    .holeBlank{ opacity:.35; }

    /* TV Mode */
    body.tv{
      background:#0b0b0b;
      color:#fff;
    }
    body.tv .wrap{ max-width:1600px; padding:18px; }
    body.tv .card{ border-color:#222; background:#111; box-shadow:none; }
    body.tv .topHeaderImg{ background:#111; border-bottom:1px solid rgba(255,255,255,.08); }
    body.tv .section, body.tv .top{ background:#111; }
    body.tv .sectionHeader, body.tv #sponsorHero, body.tv .teamCard, body.tv .tableWrap{
      background:rgba(255,255,255,.06);
      border-color:rgba(255,255,255,.14);
    }
    body.tv .pill{ background:rgba(255,255,255,.08); border-color:rgba(255,255,255,.16); }
    body.tv button, body.tv .btn{ background:rgba(255,255,255,.10); border-color:rgba(255,255,255,.18); color:#fff; }
    body.tv th{ background:rgba(255,255,255,.08); }
    body.tv th, body.tv td{ border-color:rgba(255,255,255,.12); }
    body.tv .teamName{ font-size:44px; }
    body.tv .teamScore{ font-size:56px; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">

      <!-- header image auto-switches based on tournament courseDefault -->
      <img id="courseHeaderImg" class="topHeaderImg" src="./assets/cypress_header.png" alt="Course Header">

      <div class="top">
        <h1 id="pageTitle">Live Leaderboard</h1>
        <div class="meta" id="pageMeta">Loading‚Ä¶</div>
        <div class="clubLine" id="clubLine">Cypresswood Golf Club</div>

        <div id="sponsorHero" aria-label="Tournament Sponsor">
          <div id="sponsorHeroTitle">Tournament Sponsor</div>
          <div id="sponsorHeroRow">
            <img id="sponsorHeroLogo" alt="Sponsor Logo">
            <div>
              <div id="sponsorHeroName"></div>
              <div id="sponsorHeroHint">Tap to open sponsor</div>
            </div>
          </div>
        </div>

        <div class="bar">
          <div class="pill" id="statusPill">‚õ≥Ô∏è LIVE</div>

          <button id="refreshBtn">üîÑ Refresh</button>
          <a id="joinBtn" class="btn" href="./index.html">üë• Join Link</a>
          <button id="copyBtn" class="copyBtn">üìã Copy Leaderboard Link</button>
          <button id="tvBtn" class="tvBtn">üì∫ TV Mode</button>
          <button id="autoBtn">‚¨áÔ∏è Auto Scroll: Off</button>
        </div>
      </div>

      <div class="section">
        <div class="sectionHeader">
          <div class="sectionTitle">üèÜ Top Teams</div>
          <div class="sectionSub" id="lastUpdate">Last update: ‚Äî</div>
        </div>

        <div class="topGrid" id="topGrid"></div>

        <div style="height:12px"></div>

        <div class="sectionHeader">
          <div class="sectionTitle">All Teams</div>
          <div class="sectionSub" id="teamCount">0 teams</div>
        </div>

        <div class="tableWrap" id="tableWrap">
          <table>
            <thead>
              <tr>
                <th style="width:90px;">Rank</th>
                <th>Team / Player</th>
                <th style="width:120px;">Group</th>
                <th style="width:110px;">Out</th>
                <th style="width:110px;">In</th>
                <th style="width:110px;">Total</th>
              </tr>
            </thead>
            <tbody id="allBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Golf-styled modal -->
  <div class="modalOverlay" id="modalOverlay" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalTop">
        <div class="modalTitle" id="modalTitle">Team</div>
        <button class="modalClose" id="modalClose">Close</button>
      </div>
      <div class="modalBody">
        <div class="scoreMiniRow">
          <div class="bigScore" id="modalScore">‚Äî</div>
          <div class="miniMeta" id="modalMeta">‚Äî</div>
        </div>

        <div style="font-family:Cinzel,serif; font-weight:900; opacity:.9;">Front 9</div>
        <div class="holesGrid" id="frontGrid"></div>

        <div style="height:12px"></div>

        <div style="font-family:Cinzel,serif; font-weight:900; opacity:.9;">Back 9</div>
        <div class="holesGrid" id="backGrid"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore,
      doc,
      getDoc,
      collection,
      getDocs,
      query,
      orderBy
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBX2ycbIGEyQh-XgeOXtuhkyBT2XZvsHls",
      authDomain: "cypresswood-tournaments.firebaseapp.com",
      projectId: "cypresswood-tournaments",
      storageBucket: "cypresswood-tournaments.firebasestorage.app",
      messagingSenderId: "162441374966",
      appId: "1:162441374966:web:157285a2d5c39db1e810d7",
      measurementId: "G-HL6Y9CLV8K"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const $ = (id) => document.getElementById(id);

    const pageTitle = $("pageTitle");
    const pageMeta = $("pageMeta");
    const clubLine = $("clubLine");
    const statusPill = $("statusPill");
    const joinBtn = $("joinBtn");
    const copyBtn = $("copyBtn");
    const refreshBtn = $("refreshBtn");
    const tvBtn = $("tvBtn");
    const autoBtn = $("autoBtn");

    const sponsorHero = $("sponsorHero");
    const sponsorHeroLogo = $("sponsorHeroLogo");
    const sponsorHeroName = $("sponsorHeroName");

    const courseHeaderImg = $("courseHeaderImg");

    const topGrid = $("topGrid");
    const allBody = $("allBody");
    const teamCount = $("teamCount");
    const lastUpdate = $("lastUpdate");
    const tableWrap = $("tableWrap");

    const modalOverlay = $("modalOverlay");
    const modalClose = $("modalClose");
    const modalTitle = $("modalTitle");
    const modalScore = $("modalScore");
    const modalMeta = $("modalMeta");
    const frontGrid = $("frontGrid");
    const backGrid = $("backGrid");

    const params = new URLSearchParams(location.search);
    const tId = (params.get("t") || "").trim();
    const adminToken = (params.get("admin") || "").trim();

    // ----- header mapping -----
    function setHeaderForCourse(courseDefault){
      // You said: cypress => cypress header; tradition => tradition header
      const c = (courseDefault || "").toLowerCase().trim();
      if(c === "tradition"){
        courseHeaderImg.src = "./assets/cypresswood_header.png";
        courseHeaderImg.alt = "Tradition Header";
      }else{
        courseHeaderImg.src = "./assets/cypress_header.png";
        courseHeaderImg.alt = "Cypress Header";
      }
    }

    function normalizeUrl(u){
      const s = (u || "").trim();
      if(!s) return "";
      if(/^https?:\/\//i.test(s)) return s;
      return "https://" + s;
    }

    function safeText(x){ return (x == null) ? "" : String(x); }

    function fmtDate(d){
      try{
        return new Date(d).toLocaleString();
      }catch(e){
        return String(d || "");
      }
    }

    // Auto-scroll for All Teams
    let autoOn = false;
    let autoRaf = null;
    let autoDir = 1;
    function startAutoScroll(){
      stopAutoScroll();
      autoOn = true;
      autoBtn.textContent = "‚¨áÔ∏è Auto Scroll: On";

      const step = () => {
        if(!autoOn) return;

        // scroll inside tableWrap
        const el = tableWrap;
        const max = el.scrollHeight - el.clientHeight;

        if(max <= 0){
          autoRaf = requestAnimationFrame(step);
          return;
        }

        el.scrollTop += (document.body.classList.contains("tv") ? 1.6 : 1.0) * autoDir;

        if(el.scrollTop >= max - 2) autoDir = -1;
        if(el.scrollTop <= 2) autoDir = 1;

        autoRaf = requestAnimationFrame(step);
      };
      autoRaf = requestAnimationFrame(step);
    }
    function stopAutoScroll(){
      autoOn = false;
      autoBtn.textContent = "‚¨áÔ∏è Auto Scroll: Off";
      if(autoRaf) cancelAnimationFrame(autoRaf);
      autoRaf = null;
      autoDir = 1;
    }

    autoBtn.addEventListener("click", () => {
      if(autoOn) stopAutoScroll();
      else startAutoScroll();
    });

    // TV Mode toggle
    function setTV(on){
      if(on) document.body.classList.add("tv");
      else document.body.classList.remove("tv");
      localStorage.setItem("lb_tv_mode", on ? "1" : "0");
    }
    tvBtn.addEventListener("click", () => {
      const on = !document.body.classList.contains("tv");
      setTV(on);
    });
    setTV(localStorage.getItem("lb_tv_mode") === "1");

    // Modal
    function openModal(team){
      modalTitle.textContent = team.displayName || "Team";
      modalScore.textContent = String(team.total ?? 0);

      const line1 = `Out ${team.out ?? 0} ‚Ä¢ In ${team.inn ?? 0} ‚Ä¢ Group ${team.group || "-"}`;
      const line2 = team.courseId ? `Course: ${team.courseId}` : "";
      modalMeta.textContent = line2 ? (line1 + "\n" + line2) : line1;

      // build hole chips
      frontGrid.innerHTML = "";
      backGrid.innerHTML = "";
      for(let h=1; h<=9; h++){
        frontGrid.appendChild(holeChip(h, team.holes?.[h] ?? ""));
      }
      for(let h=10; h<=18; h++){
        backGrid.appendChild(holeChip(h, team.holes?.[h] ?? ""));
      }

      modalOverlay.style.display = "flex";
    }

    function closeModal(){
      modalOverlay.style.display = "none";
    }
    modalClose.addEventListener("click", closeModal);
    modalOverlay.addEventListener("click", (e) => {
      if(e.target === modalOverlay) closeModal();
    });

    function holeChip(holeNum, val){
      const div = document.createElement("div");
      div.className = "holeChip";
      const v = String(val || "");
      const blank = v.trim() === "" || v.trim() === "-";
      div.innerHTML = `
        <div class="holeNum">Hole ${holeNum}</div>
        <div class="holeVal ${blank ? "holeBlank" : ""}">${blank ? "‚Äî" : v}</div>
      `;
      return div;
    }

    // Copy leaderboard link
    async function copyText(txt){
      try{
        await navigator.clipboard.writeText(txt);
        alert("Copied!");
      }catch(e){
        alert("Copy blocked. Press and hold to select the URL.");
      }
    }

    // Build this page URL (no hash weirdness)
    function currentURL(){
      const u = new URL(location.href);
      u.hash = "";
      return u.toString();
    }

    // Determine how to compute ‚Äúteam‚Äù score by tournament format
    function formatToPlayersCount(fmt){
      if(fmt === "scramble") return 1;
      if(fmt === "bestball") return 2;
      return 6;
    }

    // Pull holes from a submission:
    // - We store scoresFlat keys like "p0_h1"
    // For scramble, we only care p0; for stroke we display p0 by default in modal.
    function extractHolesFromScoresFlat(scoresFlat, playerIndex=0){
      const holes = {};
      for(let h=1; h<=18; h++){
        const key = `p${playerIndex}_h${h}`;
        holes[h] = (scoresFlat && scoresFlat[key] != null) ? String(scoresFlat[key] || "") : "";
      }
      return holes;
    }

    // Rank total:
    // - scramble => p0 total
    // - stroke/skins => use submission totals[0] by default (the ‚ÄúplayerName‚Äù leader)
    // You can later adjust to aggregate by group/team.
    function getPrimaryTotals(sub){
      const totals = Array.isArray(sub.totals) ? sub.totals : [];
      const t0 = totals[0] || { out:0, inn:0, tot:0 };
      return {
        out: Number(t0.out || 0) || 0,
        inn: Number(t0.inn || 0) || 0,
        tot: Number(t0.tot || 0) || 0
      };
    }

    function buildTeamDisplay(sub, tFormat){
      const playerName = safeText(sub.playerName || sub.names?.[0] || "Player");
      const group = safeText(sub.group || "");
      const courseId = safeText(sub.courseId || "");
      const totals = getPrimaryTotals(sub);

      // displayName: scramble can show group as team label if provided
      const displayName =
        (tFormat === "scramble" && group) ? group :
        playerName;

      // holes from p0 (for now)
      const holes = extractHolesFromScoresFlat(sub.scoresFlat || {}, 0);

      return {
        displayName,
        playerName,
        group,
        courseId,
        out: totals.out,
        inn: totals.inn,
        total: totals.tot,
        holes,
        updatedAt: sub.updatedAt
      };
    }

    // Render
    function renderAll(teams){
      // sort low total is best
      const sorted = [...teams].sort((a,b) => (a.total - b.total) || (a.displayName.localeCompare(b.displayName)));

      teamCount.textContent = `${sorted.length} team${sorted.length === 1 ? "" : "s"}`;

      // Top Teams cards (top 3)
      topGrid.innerHTML = "";
      const top = sorted.slice(0, 3);
      top.forEach((t, idx) => {
        const card = document.createElement("div");
        card.className = "teamCard";
        card.innerHTML = `
          <div class="rankBadge">üèÖ <span>${idx === 0 ? "1ST" : idx === 1 ? "2ND" : "3RD"}</span></div>
          <div class="teamName">${escapeHtml(t.displayName)}</div>
          <div class="teamScore">${escapeHtml(String(t.total))}</div>
          <div class="teamMeta">Out ${t.out} ‚Ä¢ In ${t.inn} ‚Ä¢ ${t.group ? "Group " + escapeHtml(t.group) : "Group -"}</div>
        `;
        card.addEventListener("click", () => openModal(t));
        topGrid.appendChild(card);
      });

      // All Teams table
      allBody.innerHTML = "";
      sorted.forEach((t, idx) => {
        const tr = document.createElement("tr");
        tr.className = "rowTap";
        tr.innerHTML = `
          <td><b>#${idx+1}</b></td>
          <td>
            <div style="font-weight:900; font-size:18px;">${escapeHtml(t.displayName)}</div>
            <div class="muted">${escapeHtml(t.courseId)} ‚Ä¢ tap for holes</div>
          </td>
          <td>${escapeHtml(t.group || "-")}</td>
          <td>${t.out}</td>
          <td>${t.inn}</td>
          <td><b>${t.total}</b></td>
        `;
        tr.addEventListener("click", () => openModal(t));
        allBody.appendChild(tr);
      });
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    async function load(){
      if(!tId){
        pageMeta.textContent = "Missing tournament id (?t=...)";
        statusPill.textContent = "‚ö†Ô∏è NO TOURNAMENT";
        return;
      }

      // build join link
      joinBtn.href = `./index.html?t=${encodeURIComponent(tId)}`;

      // copy current leaderboard link
      copyBtn.addEventListener("click", () => copyText(currentURL()));

      // read tournament doc (name, courseDefault, format, sponsor)
      let tData = null;
      try{
        const snap = await getDoc(doc(db, "tournaments", tId));
        if(snap.exists()) tData = snap.data() || {};
      }catch(e){
        console.warn("tournament doc load failed", e);
      }

      const tName = safeText(tData?.name || "Tournament");
      const courseDefault = safeText(tData?.courseDefault || "cypress");
      const tFormat = safeText(tData?.format || "stroke");
      const sponsorName = safeText(tData?.sponsorName || "");
      const sponsorLogo = safeText(tData?.sponsorLogo || "");
      const sponsorUrl = normalizeUrl(tData?.sponsorUrl || "");

      pageTitle.textContent = "Live Leaderboard";
      pageMeta.textContent = `${courseDefault} ‚Ä¢ ID: ${tId}`;
      clubLine.textContent = "Cypresswood Golf Club";

      setHeaderForCourse(courseDefault);

      // sponsor hero
      if(sponsorName || sponsorLogo){
        sponsorHero.style.display = "block";
        sponsorHeroName.textContent = sponsorName || "Tournament Sponsor";

        if(sponsorLogo){
          sponsorHeroLogo.src = sponsorLogo;
          sponsorHeroLogo.style.display = "block";
        }else{
          sponsorHeroLogo.style.display = "none";
        }

        sponsorHero.style.cursor = sponsorUrl ? "pointer" : "default";
        sponsorHero.onclick = () => {
          if(sponsorUrl) window.open(sponsorUrl, "_blank");
        };
      }else{
        sponsorHero.style.display = "none";
      }

      // load submissions
      const subs = [];
      try{
        const qRef = query(collection(db, "tournaments", tId, "submissions"), orderBy("updatedAt", "desc"));
        const snap = await getDocs(qRef);
        snap.forEach(d => subs.push({ id:d.id, ...d.data() }));
      }catch(e){
        console.warn("submissions load failed", e);
      }

      // last update
      const newest = subs[0]?.updatedAt?.toDate ? subs[0].updatedAt.toDate() : null;
      lastUpdate.textContent = "Last update: " + (newest ? newest.toLocaleString() : "‚Äî");

      // build team objects
      const teams = subs.map(s => buildTeamDisplay(s, tFormat));
      renderAll(teams);

      // status
      statusPill.textContent = `‚õ≥Ô∏è LIVE ‚Ä¢ ${tName}`;
    }

    refreshBtn.addEventListener("click", load);

    load();
  </script>

  <script src="./pwa.js"></script>
</body>
</html>
