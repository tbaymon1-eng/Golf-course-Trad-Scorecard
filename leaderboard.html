<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Live Leaderboard</title>
  <meta name="theme-color" content="#7a4a0b">
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --paper:#e9e2d4;
      --ink:#111;
      --border:#7a4a0b;
      --card:#efe7d7;
      --soft:#ffffff80;
      --good:#2f6b2f;
      --bad:#b6422d;
    }
    *{ -webkit-tap-highlight-color: transparent; }
    body{
      margin:0;
      background:var(--paper);
      color:var(--ink);
      font-family: Georgia, "Times New Roman", serif;
    }
    .wrap{ max-width: 980px; margin:0 auto; padding:12px; }
    .card{
      background:var(--card);
      border:3px solid var(--border);
      border-radius:12px;
      box-shadow:0 8px 22px rgba(0,0,0,.18);
      overflow:hidden;
    }

    .top{
      padding:12px;
      border-bottom:1px solid rgba(0,0,0,.08);
      background: linear-gradient(180deg, rgba(255,255,255,.35), rgba(255,255,255,0));
      position:relative;
    }

    /* ‚úÖ Small course header (no watermark) */
    .course-header{
      display:none;
      margin-top:10px;
      border:2px solid rgba(0,0,0,.12);
      border-radius:12px;
      background:rgba(255,255,255,.55);
      overflow:hidden;
    }
    .course-header img{
      width:100%;
      height:auto;
      display:block;
      max-height:110px;      /* small */
      object-fit:contain;
      background:rgba(255,255,255,.35);
    }

    h1{
      margin:0;
      font-family:Cinzel, serif;
      font-weight:900;
      font-size:20px;
      letter-spacing:.3px;
    }
    .meta{ margin-top:6px; font-size:13px; opacity:.85; }

    .bar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-top:10px;
      flex-wrap:wrap;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:2px solid rgba(0,0,0,.18);
      background:rgba(255,255,255,.55);
      font-weight:900;
      font-size:13px;
      font-family:Cinzel, serif;
    }

    button, a.btn{
      border:2px solid var(--border);
      background:#e7ddcb;
      border-radius:10px;
      padding:10px 10px;
      font-weight:900;
      font-size:14px;
      text-decoration:none;
      color:var(--ink);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      cursor:pointer;
    }
    button:active, a.btn:active{ transform: translateY(1px); }

    /* Sponsor Hero (single ‚ÄúTournament Sponsor‚Äù) */
    #sponsorHero{
      display:none;
      margin-top:10px;
      padding:10px 12px;
      border:2px solid rgba(0,0,0,.12);
      border-radius:12px;
      background:rgba(255,255,255,.55);
    }
    #sponsorHeroTitle{
      font-family:Cinzel,serif;
      font-weight:900;
      font-size:13px;
      opacity:.9;
      letter-spacing:.2px;
    }
    #sponsorHeroRow{
      display:flex;
      align-items:center;
      gap:10px;
      margin-top:8px;
    }
    #sponsorHeroLogo{
      width:44px; height:44px;
      border-radius:10px;
      object-fit:cover;
      border:2px solid rgba(0,0,0,.12);
      background:rgba(0,0,0,.05);
      display:none;
    }
    #sponsorHeroName{
      font-weight:900;
      font-size:16px;
    }
    #sponsorHeroHint{
      margin-top:4px;
      font-size:12px;
      opacity:.8;
    }

    /* Sponsor ticker */
    #sponsorTicker{
      display:none;
      margin: 0 12px 12px;
      border:2px solid rgba(0,0,0,.18);
      border-radius:12px;
      background:rgba(255,255,255,.55);
      overflow:hidden;
    }
    #tickerTrack{ white-space:nowrap; overflow:hidden; }
    .sponsor-chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      margin-right:10px;
      border-radius:999px;
      border:2px solid rgba(0,0,0,.18);
      background:rgba(255,255,255,.7);
      font-weight:900;
      font-size:13px;
      cursor:pointer;
    }
    .sponsor-chip:active{ transform: translateY(1px); }
    @keyframes tickerScroll {
      0% { transform: translateX(0); }
      100% { transform: translateX(-50%); }
    }
    .ticker-animate{
      animation: tickerScroll 28s linear infinite;
      will-change: transform;
      display:inline-block;
    }

    /* Spotlight */
    .spotlight{
      margin:0 12px 12px;
      border:2px solid rgba(0,0,0,.18);
      border-radius:12px;
      background:rgba(255,255,255,.55);
      overflow:hidden;
    }
    .spotlight-head{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 12px;
      border-bottom:1px solid rgba(0,0,0,.1);
      gap:10px;
      flex-wrap:wrap;
    }
    .spotlight-title{
      font-family:Cinzel, serif;
      font-weight:900;
    }
    .spotlight-grid{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
      padding:12px;
    }
    @media (max-width:680px){
      .spotlight-grid{ grid-template-columns:1fr; }
    }
    .podium{
      border:2px solid rgba(0,0,0,.12);
      border-radius:12px;
      background:rgba(255,255,255,.55);
      padding:12px;
      position:relative;
      overflow:hidden;
    }
    .podium .rank{
      font-family:Cinzel, serif;
      font-weight:900;
      font-size:14px;
      opacity:.85;
    }
    .podium .name{
      margin-top:6px;
      font-weight:900;
      font-size:16px;
    }
    .podium .score{
      margin-top:6px;
      font-family:Cinzel, serif;
      font-weight:900;
      font-size:20px;
    }
    .podium .sub{
      margin-top:4px;
      font-size:12px;
      opacity:.85;
    }

    /* Table */
    .table-wrap{
      margin:0 12px 12px;
      border:2px solid rgba(0,0,0,.18);
      border-radius:12px;
      overflow:hidden;
      background:rgba(255,255,255,.55);
    }
    .table-head{
      padding:10px 12px;
      border-bottom:1px solid rgba(0,0,0,.1);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .table-title{
      font-family:Cinzel, serif;
      font-weight:900;
    }
    .muted{ opacity:.8; font-size:12px; }
    .scroll-x{
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
    }
    table{
      border-collapse:collapse;
      width:100%;
      min-width: 760px;
    }
    th, td{
      border: 1.5px solid rgba(0,0,0,.18);
      padding:10px 10px;
      text-align:left;
      background:rgba(255,255,255,.55);
      font-size:14px;
    }
    th{
      background:rgba(0,0,0,.06);
      font-family:Cinzel, serif;
      font-weight:900;
      white-space:nowrap;
    }
    .right{ text-align:right; }
    .center{ text-align:center; }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 8px;
      border-radius:999px;
      border:2px solid rgba(0,0,0,.12);
      background:rgba(255,255,255,.7);
      font-weight:900;
      font-size:12px;
      white-space:nowrap;
    }
    .empty{
      padding:14px 12px;
      font-size:14px;
      opacity:.85;
    }

    /* ‚úÖ TV Broadcast Mode */
    body.tv .wrap{ max-width: 1400px; }
    body.tv h1{ font-size:28px; }
    body.tv th, body.tv td{ font-size:18px; padding:14px 12px; }
    body.tv .podium .score{ font-size:30px; }
    body.tv .course-header img{ max-height:140px; }

    /* ‚úÖ Auto scroll (TV) visual hint */
    #autoScrollPill{
      display:none;
    }
    body.tv #autoScrollPill{
      display:inline-flex;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <h1 id="pageTitle">Live Leaderboard</h1>
        <div class="meta" id="pageMeta">Loading‚Ä¶</div>

        <!-- ‚úÖ Course header (small) -->
        <div class="course-header" id="courseHeaderBox">
          <img id="courseHeaderImg" alt="Course Header" />
        </div>

        <!-- ‚úÖ Tournament Sponsor (single hero) -->
        <div id="sponsorHero">
          <div id="sponsorHeroTitle">Tournament Sponsor</div>
          <div id="sponsorHeroRow">
            <img id="sponsorHeroLogo" alt="Sponsor Logo"/>
            <div>
              <div id="sponsorHeroName">‚Äî</div>
              <div id="sponsorHeroHint" class="muted" style="display:none;">Tap sponsor chips below to open</div>
            </div>
          </div>
        </div>

        <div class="bar">
          <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
            <div class="pill" id="statusPill">‚õ≥Ô∏è LIVE</div>
            <div class="pill" id="autoScrollPill">üì∫ Auto-scroll</div>
          </div>

          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button id="refreshBtn">üîÑ Refresh</button>
            <a id="joinBtn" class="btn" href="./index.html">üë• Join Link</a>
            <button id="copyBtn">üìã Copy Leaderboard Link</button>
            <button id="tvBtn">üì∫ TV Mode</button>
          </div>
        </div>
      </div>

      <!-- Sponsors ticker -->
      <div id="sponsorTicker">
        <div style="display:flex; align-items:center; gap:10px; padding:10px 12px; border-bottom:1px solid rgba(0,0,0,.1);">
          <div style="font-family:Cinzel,serif; font-weight:900;">Sponsored by</div>
          <div style="font-size:12px; opacity:.85;">(tap a sponsor to open)</div>
        </div>
        <div style="position:relative; white-space:nowrap; overflow:hidden;">
          <div id="tickerTrack" style="display:inline-block; padding:10px 12px;"></div>
        </div>
      </div>

      <!-- Spotlight -->
      <div class="spotlight">
        <div class="spotlight-head">
          <div class="spotlight-title">üèÜ Top Teams</div>
          <div class="muted" id="lastUpdated">‚Äî</div>
        </div>
        <div class="spotlight-grid" id="podiumGrid"></div>
      </div>

      <!-- Table -->
      <div class="table-wrap">
        <div class="table-head">
          <div class="table-title">All Teams</div>
          <div class="muted" id="teamCount">0 teams</div>
        </div>
        <div class="scroll-x" id="tableScroll">
          <table>
            <thead>
              <tr>
                <th style="width:60px;" class="center">Rank</th>
                <th>Team / Player</th>
                <th style="width:90px;" class="center">Group</th>
                <th style="width:110px;" class="right">Out</th>
                <th style="width:110px;" class="right">In</th>
                <th style="width:110px;" class="right">Total</th>
                <th style="width:170px;">Last Update</th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>
        <div id="emptyState" class="empty" style="display:none;">
          No scores yet. Once teams enter scores in the scorecard, they‚Äôll appear here automatically.
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore,
      doc,
      getDoc,
      collection,
      query,
      where,
      onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // ‚úÖ Same config you used elsewhere
    const firebaseConfig = {
      apiKey: "AIzaSyBX2ycbIGEyQh-XgeOXtuhkyBT2XZvsHls",
      authDomain: "cypresswood-tournaments.firebaseapp.com",
      projectId: "cypresswood-tournaments",
      storageBucket: "cypresswood-tournaments.firebasestorage.app",
      messagingSenderId: "162441374966",
      appId: "1:162441374966:web:157285a2d5c39db1e810d7",
      measurementId: "G-HL6Y9CLV8Y9CLV8K"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const $ = (id) => document.getElementById(id);

    const pageTitle = $("pageTitle");
    const pageMeta = $("pageMeta");
    const statusPill = $("statusPill");
    const refreshBtn = $("refreshBtn");
    const copyBtn = $("copyBtn");
    const joinBtn = $("joinBtn");
    const tvBtn = $("tvBtn");

    const courseHeaderBox = $("courseHeaderBox");
    const courseHeaderImg = $("courseHeaderImg");

    const sponsorHero = $("sponsorHero");
    const sponsorHeroLogo = $("sponsorHeroLogo");
    const sponsorHeroName = $("sponsorHeroName");
    const sponsorHeroHint = $("sponsorHeroHint");

    const podiumGrid = $("podiumGrid");
    const rowsTbody = $("rows");
    const emptyState = $("emptyState");
    const teamCount = $("teamCount");
    const lastUpdated = $("lastUpdated");
    const tableScroll = $("tableScroll");

    // Sponsors ticker
    const sponsorTicker = $("sponsorTicker");
    const tickerTrack = $("tickerTrack");

    // ===== URL Params =====
    const params = new URLSearchParams(location.search);
    const tournamentId = (params.get("t") || "").trim();

    function baseURL(){
      return location.origin + location.pathname.replace(/leaderboard\.html.*$/,"");
    }

    function fmtTime(ts){
      try{
        if(!ts) return "‚Äî";
        const d = ts.toDate ? ts.toDate() : new Date(ts);
        return d.toLocaleString();
      }catch(e){ return "‚Äî"; }
    }

    function safe(s){
      return String(s || "").replace(/</g,"&lt;");
    }

    async function copyText(txt){
      try{
        await navigator.clipboard.writeText(txt);
        alert("Copied!");
      }catch(e){
        alert("Copy blocked. Press and hold to select the link.");
      }
    }

    copyBtn.addEventListener("click", () => copyText(location.href));
    refreshBtn.addEventListener("click", () => location.reload());

    // ‚úÖ TV mode toggle (?tv=1) + button
    function setTVMode(on){
      document.body.classList.toggle("tv", !!on);
      params.set("tv", on ? "1" : "0");
      const u = new URL(location.href);
      u.searchParams.set("tv", on ? "1" : "0");
      history.replaceState(null, "", u.toString());
      tvBtn.textContent = on ? "üß∞ Exit TV" : "üì∫ TV Mode";
      if(on) startAutoScroll(); else stopAutoScroll();
    }
    const tvOn = (params.get("tv") === "1");
    tvBtn.addEventListener("click", () => setTVMode(!document.body.classList.contains("tv")));
    if(tvOn) setTVMode(true);

    // ===== Guard =====
    if(!tournamentId){
      pageTitle.textContent = "Leaderboard";
      pageMeta.textContent = "Missing tournament id. Open the link from admin.html.";
      statusPill.textContent = "‚ö†Ô∏è Missing ID";
      throw new Error("Missing tournamentId");
    }

    joinBtn.href = `${baseURL()}index.html?t=${encodeURIComponent(tournamentId)}`;

    // ====================== TOURNAMENT DOC (title + status + sponsor + course header) ======================
    const tRef = doc(db, "tournaments", tournamentId);

    function applyCourseHeader(courseDefault){
      const c = (courseDefault || "").toString().toLowerCase();
      // Your existing assets
      const src =
        c === "cypress" ? "./assets/cypress_header.png" :
        c === "tradition" ? "./assets/cypresswood_header.png" :
        "";

      if(src){
        courseHeaderImg.src = src;
        courseHeaderImg.alt = c === "cypress" ? "Cypress Course" : "Tradition Course";
        courseHeaderBox.style.display = "block";
      }else{
        courseHeaderBox.style.display = "none";
      }
    }

    try{
      const snap = await getDoc(tRef);
      if(snap.exists()){
        const t = snap.data() || {};
        pageTitle.textContent = `Live Leaderboard`;
        pageMeta.textContent = `${t.name || "Tournament"} ‚Ä¢ ID: ${tournamentId}`;

        if((t.status || "open") === "closed") statusPill.textContent = "üîí CLOSED";
        else statusPill.textContent = "‚õ≥Ô∏è LIVE";

        // ‚úÖ course header from admin selection
        applyCourseHeader(t.courseDefault);

        // ‚úÖ sponsor hero (from admin.html fields: sponsorName + sponsorLogo)
        const sName = (t.sponsorName || "").trim();
        const sLogo = (t.sponsorLogo || "").trim();
        if(sName || sLogo){
          sponsorHero.style.display = "block";
          sponsorHeroName.textContent = sName || "Tournament Sponsor";

          if(sLogo){
            sponsorHeroLogo.src = sLogo;
            sponsorHeroLogo.style.display = "block";
          }else{
            sponsorHeroLogo.style.display = "none";
          }
        }else{
          sponsorHero.style.display = "none";
        }
      }else{
        pageMeta.textContent = `Tournament not found ‚Ä¢ ID: ${tournamentId}`;
        statusPill.textContent = "‚ö†Ô∏è Not Found";
      }
    }catch(e){
      pageMeta.textContent = `Could not load tournament ‚Ä¢ ID: ${tournamentId}`;
      statusPill.textContent = "‚ö†Ô∏è Error";
    }

    // ====================== SUBMISSIONS -> LEADERBOARD ======================
    const subRef = collection(db, "tournaments", tournamentId, "submissions");
    const subQuery = query(subRef);

    let latestUpdate = null;

    function calcTotalsFromFlat(scoresFlat, playerIndex){
      // reads p{player}_h{hole}
      let out = 0, inn = 0;
      for(let h=1; h<=18; h++){
        const key = `p${playerIndex}_h${h}`;
        const v = (scoresFlat?.[key] ?? "").toString().trim();
        const n = parseInt(v,10);
        if(Number.isFinite(n)){
          if(h<=9) out += n; else inn += n;
        }
      }
      return { out, inn, tot: out+inn };
    }

    function renderPodium(list){
      const top = list.slice(0,3);
      const labels = ["ü•á 1st", "ü•à 2nd", "ü•â 3rd"];
      podiumGrid.innerHTML = "";

      if(!top.length){
        podiumGrid.innerHTML = `
          <div class="podium">
            <div class="rank">‚Äî</div>
            <div class="name">Waiting for scores‚Ä¶</div>
            <div class="score">‚Äî</div>
            <div class="sub">Teams will appear here in real time.</div>
          </div>
        `;
        return;
      }

      top.forEach((t,i) => {
        podiumGrid.insertAdjacentHTML("beforeend", `
          <div class="podium">
            <div class="rank">${labels[i] || `#${i+1}`}</div>
            <div class="name">${safe(t.teamName)}</div>
            <div class="score">${t.tot}</div>
            <div class="sub">Out ${t.out} ‚Ä¢ In ${t.inn} ${t.group ? `‚Ä¢ Group ${safe(t.group)}` : ""}</div>
          </div>
        `);
      });
    }

    function renderTable(list){
      rowsTbody.innerHTML = "";
      emptyState.style.display = list.length ? "none" : "block";
      teamCount.textContent = `${list.length} ${list.length===1 ? "team" : "teams"}`;

      list.forEach((t, idx) => {
        rowsTbody.insertAdjacentHTML("beforeend", `
          <tr>
            <td class="center"><span class="badge">#${idx+1}</span></td>
            <td>
              <div style="font-weight:900;">${safe(t.teamName)}</div>
              <div class="muted">${safe(t.courseId || "")} ‚Ä¢ tap for holes</div>
            </td>
            <td class="center">${t.group ? `<span class="badge">${safe(t.group)}</span>` : "‚Äî"}</td>
            <td class="right">${t.out}</td>
            <td class="right">${t.inn}</td>
            <td class="right"><span class="badge">‚õ≥Ô∏è ${t.tot}</span></td>
            <td>${safe(t.updatedLabel)}</td>
          </tr>
        `);
      });
    }

    // ‚úÖ tap a row to show hole-by-hole (admin/organizer view)
    rowsTbody.addEventListener("click", (e) => {
      const tr = e.target.closest("tr");
      if(!tr) return;
      const id = tr.getAttribute("data-id");
      const team = window.__teams?.find(x => x.id === id);
      if(!team) return;

      const lines = [];
      for(let h=1; h<=18; h++){
        const k = `p0_h${h}`; // show player 1 row for now (MVP)
        const v = (team.scoresFlat?.[k] ?? "");
        lines.push(`${h}:${v || "-"}`);
      }
      alert(`${team.teamName}\n\nHoles (P1):\n` + lines.join("  "));
    });

    onSnapshot(subQuery, (snap) => {
      const teams = [];
      latestUpdate = null;

      snap.forEach((d) => {
        const data = d.data() || {};
        const names = Array.isArray(data.names) ? data.names : [];
        const scoresFlat = (data.scoresFlat && typeof data.scoresFlat === "object") ? data.scoresFlat : null;

        const teamName =
          (data.playerName || "").trim() ||
          (names[0] || "").trim() ||
          `Team ${d.id.slice(0,5)}`;

        let out = 0, inn = 0, tot = 0;

        if (Array.isArray(data.totals) && data.totals[0] && typeof data.totals[0] === "object") {
          out = Number(data.totals[0].out || 0) || 0;
          inn = Number(data.totals[0].inn || 0) || 0;
          tot = Number(data.totals[0].tot || (out+inn)) || (out+inn);
        } else if (scoresFlat) {
          const computed = calcTotalsFromFlat(scoresFlat, 0); // MVP: first player row
          out = computed.out; inn = computed.inn; tot = computed.tot;
        } else {
          out = 0; inn = 0; tot = 0;
        }

        const updatedAt = data.updatedAt || data.lastJoin || null;
        if (updatedAt && updatedAt.toDate){
          const dt = updatedAt.toDate();
          if(!latestUpdate || dt > latestUpdate) latestUpdate = dt;
        }

        teams.push({
          id: d.id,
          teamName,
          group: (data.group || "").toString().trim(),
          courseId: (data.courseId || "").toString().trim(),
          out, inn, tot,
          updatedLabel: updatedAt ? fmtTime(updatedAt) : "‚Äî",
          updatedAt,
          scoresFlat
        });
      });

      teams.sort((a,b) => {
        if(a.tot !== b.tot) return a.tot - b.tot;
        const at = a.updatedAt?.toDate ? a.updatedAt.toDate().getTime() : 0;
        const bt = b.updatedAt?.toDate ? b.updatedAt.toDate().getTime() : 0;
        return bt - at;
      });

      // expose for click handler
      window.__teams = teams;

      // render
      renderPodium(teams);
      // add data-id on rows
      rowsTbody.innerHTML = "";
      emptyState.style.display = teams.length ? "none" : "block";
      teamCount.textContent = `${teams.length} ${teams.length===1 ? "team" : "teams"}`;

      teams.forEach((t, idx) => {
        rowsTbody.insertAdjacentHTML("beforeend", `
          <tr data-id="${safe(t.id)}">
            <td class="center"><span class="badge">#${idx+1}</span></td>
            <td>
              <div style="font-weight:900;">${safe(t.teamName)}</div>
              <div class="muted">${safe(t.courseId || "")} ‚Ä¢ tap for holes</div>
            </td>
            <td class="center">${t.group ? `<span class="badge">${safe(t.group)}</span>` : "‚Äî"}</td>
            <td class="right">${t.out}</td>
            <td class="right">${t.inn}</td>
            <td class="right"><span class="badge">‚õ≥Ô∏è ${t.tot}</span></td>
            <td>${safe(t.updatedLabel)}</td>
          </tr>
        `);
      });

      lastUpdated.textContent = latestUpdate ? `Last update: ${latestUpdate.toLocaleString()}` : "Last update: ‚Äî";
    });

    // ====================== SPONSORS (ticker) ======================
    // Reads: tournaments/{t}/sponsors/{sponsorId} where active == true
    const sponsorRef = collection(db, "tournaments", tournamentId, "sponsors");
    const sponsorQuery = query(sponsorRef, where("active","==",true));

    function openSponsor(s){
      if (s.linkUrl) window.open(s.linkUrl, "_blank");
    }

    function renderTicker(list){
      if(!list.length){
        sponsorTicker.style.display = "none";
        sponsorHeroHint.style.display = "none";
        return;
      }
      sponsorTicker.style.display = "block";
      sponsorHeroHint.style.display = "block";

      const chipsHTML = list.map(s => {
        const tier = (s.tier || "").toLowerCase();
        const label = tier === "gold" ? "üèÜ" : tier === "silver" ? "ü•à" : tier === "bronze" ? "ü•â" : "‚õ≥Ô∏è";
        return `<span class="sponsor-chip" data-id="${safe(s.id)}">${label} ${safe(s.name || "Sponsor")}</span>`;
      }).join("");

      tickerTrack.innerHTML = `<div id="tickerInner" class="ticker-animate">${chipsHTML}${chipsHTML}</div>`;

      requestAnimationFrame(() => {
        const inner = document.getElementById("tickerInner");
        if(!inner) return;
        if(inner.scrollWidth < 900) inner.classList.remove("ticker-animate");
      });

      tickerTrack.querySelectorAll(".sponsor-chip").forEach(el => {
        el.addEventListener("click", () => {
          const id = el.getAttribute("data-id");
          const s = list.find(x => x.id === id);
          if (s) openSponsor(s);
        });
      });
    }

    onSnapshot(sponsorQuery, (snap) => {
      const sponsors = snap.docs.map(d => ({ id:d.id, ...d.data() }));
      const tick = sponsors
        .filter(s => {
          const p = s.placement || [];
          return p.length === 0 || p.includes("ticker");
        })
        .sort((a,b) => (a.name||"").localeCompare(b.name||""));
      renderTicker(tick);
    });

    // ====================== TV Auto Scroll ======================
    let scrollTimer = null;
    function startAutoScroll(){
      stopAutoScroll();
      if(!tableScroll) return;

      let dir = 1;
      scrollTimer = setInterval(() => {
        if(!document.body.classList.contains("tv")) return;

        tableScroll.scrollLeft += 2 * dir;

        const max = tableScroll.scrollWidth - tableScroll.clientWidth;
        if(tableScroll.scrollLeft >= max - 2) dir = -1;
        if(tableScroll.scrollLeft <= 2) dir = 1;
      }, 20);
    }
    function stopAutoScroll(){
      if(scrollTimer) clearInterval(scrollTimer);
      scrollTimer = null;
    }
  </script>

  <!-- Optional: keeps SW up to date if you already use pwa.js -->
  <script src="./pwa.js"></script>
</body>
</html>
